<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ subject_info.name }} - Learning Platform</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/styles.css') }}"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <!-- YouTube API -->
    <script src="https://www.youtube.com/iframe_api"></script>
  </head>
  <body>
    <header>
      <div class="header-content">
        <div class="header-actions">
          <div class="breadcrumb-section">
            <div class="breadcrumb">
              <a href="/">Learning Platform</a>
              <span class="separator">›</span>
              <span class="current">{{ subject_info.name }}</span>
            </div>
            <h1>
              <i
                class="{{ subject_info.icon }}"
                style="color: {{ subject_info.color }};"
              ></i>
              {{ subject_info.name }}
            </h1>
            <p class="subtitle">{{ subject_info.description }}</p>
          </div>

          <!-- Admin Override Controls -->
          <div class="admin-actions" style="margin-top: 10px">
            <button
              id="toggleOverrideBtn"
              onclick="toggleAdminOverride()"
              class="action-btn secondary"
              title="Toggle admin override to bypass prerequisites"
            >
              <i class="fas fa-key"></i>
              <span id="overrideStatus">Enable Override</span>
            </button>
          </div>
        </div>
      </div>
    </header>

    <div class="topics-grid">
      {% for subtopic_id, subtopic_data in subtopics.items() %}
      <div
        class="topic-card"
        id="{{ subtopic_id }}-card"
        data-subtopic="{{ subtopic_id }}"
      >
        <div
          class="topic-header"
          style="background: linear-gradient(135deg, {{ subject_info.color }} 0%, {{ subject_info.color }}cc 50%, {{ subject_info.color }}ee 100%); box-shadow: 0 4px 8px {{ subject_info.color }}33;"
        >
          <h3>{{ subtopic_data.name }}</h3>
          <span class="completion-badge" id="{{ subtopic_id }}-badge">
            {% if subtopic_data.status == 'active' %} Available {% else %}
            Locked {% endif %}
          </span>
        </div>
        <div class="topic-content">
          <p class="topic-description">{{ subtopic_data.description }}</p>

          <div class="topic-stats">
            <div class="stat">
              <i class="fas fa-clock"></i>
              <span>{{ subtopic_data.estimated_time }}</span>
            </div>
            <div class="stat">
              <i class="fas fa-video"></i>
              <span>{{ subtopic_data.video_count }} Videos</span>
            </div>
            <div class="stat">
              <i class="fas fa-book"></i>
              <span id="{{ subtopic_id }}-lesson-progress"
                >{{ subtopic_data.lesson_count }} Lessons</span
              >
            </div>
            <div class="stat">
              <i class="fas fa-question-circle"></i>
              <span>{{ subtopic_data.question_count }} Questions</span>
            </div>
          </div>

          {% if subtopic_data.prerequisites %}
          <div class="prerequisites">
            <i class="fas fa-lock"></i>
            <span
              >Prerequisites: {{ subtopic_data.prerequisites | join(', ')
              }}</span
            >
          </div>
          {% endif %}

          <div class="progress-container">
            <div class="progress-bar" id="{{ subtopic_id }}-progress"></div>
          </div>

          <div class="topic-actions">
            {% if subtopic_data.video_count > 0 %} {% endif %} {% if
            subtopic_data.question_count > 0 %}
            <button
              id="quiz-btn-{{ subtopic_id }}"
              class="button quiz-btn"
              onclick="checkQuizPrerequisites('{{ subject }}', '{{ subtopic_id }}')"
            >
              <i id="quiz-icon-{{ subtopic_id }}" class="fas fa-brain"></i>
              <span>Take Quiz</span>
              <i
                id="quiz-status-{{ subtopic_id }}"
                class="quiz-status-icon"
                style="display: none"
              ></i>
            </button>
            {% endif %} {% if subtopic_data.lesson_count > 0 %}
            <button
              class="button lesson-btn"
              data-subtopic="{{ subtopic_id }}"
              onclick="showInitialLessons('{{ subject }}', '{{ subtopic_id }}')"
            >
              <i class="fas fa-book-open"></i>
              View Lessons
            </button>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Initial Learning Layout (Sidebar Style) -->
    <div
      class="blackboard-layout"
      id="initial-learning-layout"
      style="display: none"
    >
      <nav id="initial-sidebar" class="sidebar">
        <div class="sidebar-header">
          <h2 id="initial-learning-title">Initial Learning</h2>
          <p id="initial-learning-subtitle">
            Learn new concepts step by step with lessons and videos.
          </p>
        </div>

        <ul id="initial-topics-nav" class="topic-nav-list">
          <!-- Lessons and videos will be populated here -->
        </ul>

        <div class="sidebar-footer">
          <button id="backToTopicsFromInitial" class="action-button">
            <i class="fas fa-arrow-left"></i>
            Back to Topics
          </button>
        </div>
      </nav>

      <main id="initial-content-area" class="content-area">
        <div id="initial-content-display">
          <div id="initial-welcome" class="welcome-message">
            <h2>Welcome to Initial Learning</h2>
            <p>Select a lesson or video from the sidebar to begin learning.</p>
          </div>
        </div>
      </main>
    </div>

    <!-- Video Modal -->
    <div class="video-container" id="video-modal">
      <div class="modal-content">
        <div class="close-button">×</div>
        <h2 class="video-title" id="current-video-title">Video Title</h2>
        <div class="video-player">
          <iframe
            id="video-iframe"
            width="800"
            height="450"
            src=""
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen
          ></iframe>
          <div class="progress-container" style="margin-top: 10px">
            <div class="progress-bar" id="video-progress-bar"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Lesson Selector Modal -->
    <div class="lesson-modal" id="lesson-modal" style="display: none">
      <div class="lesson-modal-content">
        <div class="lesson-modal-header">
          <h2 id="lesson-modal-title">Initial Lessons - Integrals</h2>
          <button class="close-lesson-modal" onclick="closeLessonModal()">
            ×
          </button>
        </div>
        <div class="lesson-modal-body">
          <div class="lesson-type-selector" style="display: none">
            <button
              class="lesson-type-btn remedial-btn"
              onclick="showLessons('remedial')"
            >
              <i class="fas fa-bandage"></i>
              <div class="lesson-type-info">
                <h3>Remedial Lessons</h3>
                <p>Review and strengthen understanding of weak topics</p>
              </div>
            </button>
            <button
              class="lesson-type-btn initial-btn"
              onclick="showLessons('initial')"
            >
              <i class="fas fa-seedling"></i>
              <div class="lesson-type-info">
                <h3>Initial Lessons</h3>
                <p>Learn new topics and concepts from the beginning</p>
              </div>
            </button>
            <button
              class="lesson-type-btn all-btn"
              onclick="showLessons('all')"
            >
              <i class="fas fa-list"></i>
              <div class="lesson-type-info">
                <h3>All Lessons</h3>
                <p>View all available lessons for this topic</p>
              </div>
            </button>
          </div>
          <div class="lesson-list" id="lesson-list">
            <div class="lesson-list-header">
              <h3 id="lesson-list-title">Available Initial Lessons</h3>
            </div>
            <div class="lesson-items" id="lesson-items">
              <!-- Lessons will be loaded here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Lesson Viewer Modal -->
    <div
      class="lesson-viewer-modal"
      id="lesson-viewer-modal"
      style="display: none"
    >
      <div class="lesson-viewer-content">
        <div class="lesson-viewer-header">
          <button class="back-to-lessons-btn" onclick="backToLessonList()">
            <i class="fas fa-arrow-left"></i> Back to Lessons
          </button>
          <h2 id="lesson-viewer-title">Lesson Title</h2>
          <div class="lesson-viewer-actions">
            <span
              id="lesson-completed-indicator-header"
              class="lesson-completed-indicator"
              style="display: none"
            >
              <i class="fas fa-check-circle"></i> Completed
            </span>
            <button class="close-lesson-viewer" onclick="closeLessonViewer()">
              ×
            </button>
          </div>
        </div>
        <div class="lesson-viewer-body" id="lesson-viewer-body">
          <!-- Lesson content will be loaded here -->
        </div>
      </div>
    </div>

    <style>
      .header-content {
        text-align: center;
        max-width: 800px;
        margin: 0 auto;
      }

      .breadcrumb {
        margin-bottom: 1rem;
        color: #666;
      }

      .breadcrumb a {
        color: #007bff;
        text-decoration: none;
      }

      .breadcrumb a:hover {
        text-decoration: underline;
      }

      .separator {
        margin: 0 0.5rem;
      }

      .current {
        color: #333;
        font-weight: 600;
      }

      .topic-stats {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin: 1rem 0;
        justify-content: center;
      }

      .stat {
        display: flex;
        align-items: center;
        gap: 0.3rem;
        font-size: 0.85rem;
        color: #666;
        background: #f8f9fa;
        padding: 0.3rem 0.6rem;
        border-radius: 4px;
      }

      .prerequisites {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin: 1rem 0;
        padding: 0.5rem;
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 4px;
        font-size: 0.9rem;
        color: #856404;
      }

      .topic-actions {
        display: flex;
        gap: 0.75rem;
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 1rem;
      }

      /* Modern Button Styling */
      .watch-btn,
      .quiz-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.9rem;
        text-decoration: none;
        transition: all 0.3s ease;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        width: 150px;
        height: 44px;
        justify-content: center;
        letter-spacing: 0.025em;
        box-sizing: border-box;
        flex-shrink: 0;
      }

      .watch-btn {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
      }

      .watch-btn:hover {
        background: linear-gradient(135deg, #218838 0%, #1ea080 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
      }

      .quiz-btn {
        background: linear-gradient(135deg, #007bff 0%, #6610f2 100%);
        color: white;
        text-decoration: none;
      }

      .quiz-btn:hover {
        background: linear-gradient(135deg, #0056b3 0%, #5a0fc8 100%);
        text-decoration: none;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
      }

      /* Icon styling within buttons */
      .watch-btn i,
      .quiz-btn i {
        font-size: 1rem;
        opacity: 0.9;
      }

      /* Quiz prerequisite states */
      .quiz-btn-disabled {
        background: #6c757d !important;
        cursor: not-allowed !important;
        opacity: 0.7;
        position: relative;
      }

      .quiz-btn-disabled:hover {
        background: #6c757d !important;
        transform: none !important;
        box-shadow: 0 2px 4px rgba(108, 117, 125, 0.2) !important;
      }

      .quiz-btn-ready {
        background: #28a745 !important;
        animation: readyPulse 2s infinite;
      }

      .quiz-btn-ready:hover {
        background: #218838 !important;
      }

      .quiz-btn-admin {
        background: #ffc107 !important;
        color: #212529 !important;
        animation: adminPulse 2s infinite;
      }

      .quiz-btn-admin:hover {
        background: #e0a800 !important;
      }

      @keyframes adminPulse {
        0% {
          box-shadow: 0 2px 4px rgba(255, 193, 7, 0.2);
        }
        50% {
          box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
        }
        100% {
          box-shadow: 0 2px 4px rgba(255, 193, 7, 0.2);
        }
      }

      /* Quiz requirements section */
      .quiz-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
      }

      .quiz-requirements {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 8px 12px;
        width: 100%;
        max-width: 200px;
        font-size: 0.85rem;
      }

      .requirement-item {
        display: flex;
        align-items: center;
        gap: 6px;
        margin: 2px 0;
        padding: 2px 0;
      }

      .req-icon {
        width: 14px;
        font-size: 0.8rem;
        color: #6c757d;
      }

      .req-text {
        flex: 1;
        color: #495057;
      }

      .req-status {
        width: 14px;
        font-size: 0.8rem;
      }

      .req-status.complete {
        color: #28a745;
      }

      .req-status.incomplete {
        color: #dc3545;
      }

      .req-status.admin-override {
        color: #ffc107;
      }

      .quiz-status-icon {
        position: absolute;
        top: -5px;
        right: -5px;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        font-weight: bold;
        color: white;
        z-index: 1;
      }

      .quiz-status-icon.incomplete {
        background: #dc3545;
      }

      .quiz-status-icon.complete {
        background: #28a745;
      }

      .quiz-status-icon.admin-override {
        background: #ffc107;
        color: #212529;
      }

      @keyframes readyPulse {
        0% {
          box-shadow: 0 2px 4px rgba(40, 167, 69, 0.2);
        }
        50% {
          box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }
        100% {
          box-shadow: 0 2px 4px rgba(40, 167, 69, 0.2);
        }
      }

      /* Responsive design for smaller screens */
      @media (max-width: 768px) {
        .topic-actions {
          flex-direction: column;
          align-items: center;
        }

        .watch-btn,
        .quiz-btn {
          width: 180px;
          height: 44px;
        }
      }

      /* Admin Override Styles */
      .header-actions {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        width: 100%;
      }

      .breadcrumb-section {
        flex: 1;
      }

      .admin-actions {
        display: flex;
        gap: 15px;
        align-items: center;
        margin-left: 20px;
      }

      .admin-actions .action-btn.secondary {
        background: #f8f9fa;
        color: #495057;
        border: 1px solid #dee2e6;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.95rem;
        font-weight: 600;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .admin-actions .action-btn.secondary:hover {
        background: #e9ecef;
        color: #495057;
      }

      .admin-actions .action-btn.secondary.override-active {
        background: #28a745;
        color: white;
        border-color: #28a745;
      }

      .admin-actions .action-btn.secondary.override-active:hover {
        background: #218838;
        border-color: #1e7e34;
      }

      /* Notification styles */
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @media (max-width: 768px) {
        .header-actions {
          flex-direction: column;
          align-items: stretch;
        }

        .admin-actions {
          margin-left: 0;
          margin-top: 15px;
          justify-content: center;
        }

        .topic-stats {
          flex-direction: column;
          align-items: center;
        }

        .topic-actions {
          flex-direction: column;
        }
      }

      /* Lesson Modal Styles */
      .lesson-modal,
      .lesson-viewer-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .lesson-modal-content,
      .lesson-viewer-content {
        background: white;
        border-radius: 12px;
        max-width: 800px;
        max-height: 80vh;
        width: 90%;
        overflow-y: auto;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }

      .lesson-modal-header,
      .lesson-viewer-header {
        padding: 20px 30px;
        border-bottom: 1px solid #eee;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #f8f9fa;
        border-radius: 12px 12px 0 0;
      }

      .lesson-viewer-actions {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .lesson-completed-indicator {
        color: #28a745;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.95rem;
      }

      .lesson-completion-icon {
        color: #28a745;
        margin-left: 8px;
      }

      .lesson-item.lesson-completed {
        background: #f8fff9;
        border-left: 4px solid #28a745;
      }

      .lesson-item.lesson-completed:hover {
        background: #f0fff0;
        border-color: #28a745;
      }

      .lesson-completion-trigger {
        height: 1px;
        width: 100%;
        margin-top: 20px;
      }

      .lesson-completion-section {
        margin-top: 30px;
        padding: 20px;
        border-top: 2px solid #e9ecef;
        background: #f8f9fa;
        border-radius: 0 0 12px 12px;
        text-align: center;
      }

      .lesson-completion-actions {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 10px;
      }

      .lesson-completed-indicator-bottom {
        color: #28a745;
        font-weight: 600;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 8px;
        justify-content: center;
        padding: 15px;
        background: #d4edda;
        border: 1px solid #c3e6cb;
        border-radius: 8px;
      }

      .lesson-completed-indicator-bottom i {
        font-size: 1.3rem;
      }

      .mark-complete-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        font-size: 1rem;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(40, 167, 69, 0.2);
      }

      .mark-complete-btn:hover {
        background: #218838;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }

      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 6px;
        color: white;
        font-weight: 500;
        z-index: 1000;
        animation: slideIn 0.3s ease;
        max-width: 350px;
        word-wrap: break-word;
      }

      .notification.success {
        background-color: #28a745;
        border: 1px solid #1e7e34;
      }

      .notification.error {
        background-color: #dc3545;
        border: 1px solid #c82333;
      }

      .notification.info {
        background-color: #17a2b8;
        border: 1px solid #138496;
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .lesson-modal-header h2,
      .lesson-viewer-header h2 {
        margin: 0;
        color: #333;
      }

      .close-lesson-modal,
      .close-lesson-viewer {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #666;
        padding: 5px;
        line-height: 1;
      }

      .close-lesson-modal:hover,
      .close-lesson-viewer:hover {
        color: #000;
      }

      .lesson-modal-body,
      .lesson-viewer-body {
        padding: 30px;
      }

      .lesson-type-selector {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .lesson-type-btn {
        display: flex;
        align-items: center;
        gap: 20px;
        padding: 20px;
        border: 2px solid #ddd;
        border-radius: 10px;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: left;
      }

      .lesson-type-btn:hover {
        border-color: #007bff;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .lesson-type-btn.remedial-btn:hover {
        border-color: #dc3545;
        background: #fdf2f2;
      }

      .lesson-type-btn.initial-btn:hover {
        border-color: #28a745;
        background: #f2f8f2;
      }

      .lesson-type-btn.all-btn:hover {
        border-color: #6c757d;
        background: #f8f9fa;
      }

      .lesson-type-btn i {
        font-size: 32px;
        color: #666;
      }

      .lesson-type-btn.remedial-btn i {
        color: #dc3545;
      }

      .lesson-type-btn.initial-btn i {
        color: #28a745;
      }

      .lesson-type-btn.all-btn i {
        color: #6c757d;
      }

      .lesson-type-info h3 {
        margin: 0 0 5px 0;
        color: #333;
        font-size: 18px;
      }

      .lesson-type-info p {
        margin: 0;
        color: #666;
        font-size: 14px;
      }

      .lesson-list-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
      }

      .back-btn,
      .back-to-lessons-btn {
        background: #6c757d;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: background 0.3s ease;
      }

      .back-btn:hover,
      .back-to-lessons-btn:hover {
        background: #5a6268;
      }

      .lesson-list-header h3 {
        margin: 0;
        color: #333;
      }

      .lesson-items {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .lesson-item {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
      }

      .lesson-item:hover {
        border-color: #007bff;
        background: #f8f9ff;
        transform: translateX(5px);
      }

      .lesson-item-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
      }

      .lesson-item-title {
        font-weight: 600;
        color: #333;
        margin: 0;
      }

      .lesson-item-type {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
      }

      .lesson-item-type.remedial {
        background: #fed7d7;
        color: #c53030;
      }

      .lesson-item-type.initial {
        background: #c6f6d5;
        color: #2f855a;
      }

      .lesson-item-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-top: 8px;
      }

      .lesson-tag {
        background: #e9ecef;
        color: #495057;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 11px;
      }

      .lesson-btn {
        background: #17a2b8;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: background 0.3s ease;
      }

      .lesson-btn:hover {
        background: #138496;
      }

      /* Lesson Content Styles */
      .lesson-video {
        margin-bottom: 20px;
      }

      .lesson-content-blocks {
        line-height: 1.6;
      }

      .content-header {
        color: #333;
        border-bottom: 2px solid #007bff;
        padding-bottom: 5px;
        margin: 20px 0 15px 0;
      }

      .content-paragraph {
        margin: 15px 0;
        color: #555;
      }

      .content-code {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        padding: 15px;
        overflow-x: auto;
        margin: 15px 0;
        font-family: "Courier New", monospace;
      }

      .content-list {
        margin: 15px 0;
        padding-left: 20px;
      }

      .content-list li {
        margin: 5px 0;
        color: #555;
      }

      .content-summary {
        background: #e8f4f8;
        border-left: 4px solid #17a2b8;
        padding: 15px;
        margin: 20px 0;
        border-radius: 4px;
      }

      .content-summary h4 {
        margin: 0 0 10px 0;
        color: #17a2b8;
      }

      .content-summary p {
        margin: 0;
        color: #555;
      }

      .no-content,
      .error-message,
      .no-lessons {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: #666;
      }

      /* Initial Learning Layout Styles */
      .welcome-message {
        text-align: center;
        padding: 60px 40px;
        color: #666;
      }

      .welcome-message h2 {
        color: #2c3e50;
        margin-bottom: 20px;
      }

      .lesson-content,
      .video-content {
        max-width: 800px;
        margin: 0 auto;
        line-height: 1.6;
      }

      .lesson-content h2,
      .video-content h2 {
        color: #2c3e50;
        border-bottom: 2px solid #4a90e2;
        padding-bottom: 10px;
        margin-bottom: 30px;
      }

      .lesson-body {
        font-size: 1.1em;
        color: #444;
      }

      .lesson-body h3,
      .lesson-body h4 {
        color: #2c3e50;
        margin-top: 30px;
        margin-bottom: 15px;
        font-size: 1.53em;
      }

      .lesson-body p {
        margin-bottom: 20px;
      }

      .lesson-body ul,
      .lesson-body ol {
        margin-bottom: 20px;
        padding-left: 30px;
      }

      .lesson-body li {
        margin-bottom: 8px;
      }

      .lesson-body pre {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid #4a90e2;
        overflow-x: auto;
        margin: 20px 0;
      }

      .lesson-body code {
        background: #f8f9fa;
        padding: 2px 6px;
        border-radius: 4px;
        font-family: "Courier New", monospace;
      }

      .no-content,
      .error {
        text-align: center;
        padding: 20px;
        color: #666;
        font-style: italic;
      }

      .error {
        color: #dc3545;
      }

      #initial-topics-nav a {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      #initial-topics-nav a i {
        width: 16px;
        text-align: center;
      }
    </style>

    <script>
      // Lesson Modal Functions
      let currentSubject = "";
      let currentSubtopic = "";
      let currentLesson = null;

      function showInitialLessons(subject, subtopic) {
        currentSubject = subject;
        currentSubtopic = subtopic;

        // Hide the topics grid and show the blackboard layout
        document.querySelector(".topics-grid").style.display = "none";
        document.getElementById("initial-learning-layout").style.display =
          "flex";

        // Update sidebar title
        document.getElementById("initial-learning-title").textContent = `${
          subtopic.charAt(0).toUpperCase() + subtopic.slice(1)
        } Learning`;
        document.getElementById("initial-learning-subtitle").textContent =
          "Learn with lessons and videos for this topic.";

        // Load lessons and videos into sidebar
        loadInitialContent(subject, subtopic);
      }

      // New function to load content into the sidebar layout
      function loadInitialContent(subject, subtopic) {
        const navList = document.getElementById("initial-topics-nav");
        navList.innerHTML =
          '<li><div class="loading">Loading content...</div></li>';

        // Load both lessons and videos
        Promise.all([
          fetch(`/api/lesson-plans/${subject}/${subtopic}`)
            .then((r) => r.json())
            .catch(() => ({ lessons: {} })),
          fetch(`/api/video/${subject}/${subtopic}/all`)
            .then((r) => r.json())
            .catch(() => ({ videos: {} })),
        ])
          .then(([lessonData, videoData]) => {
            navList.innerHTML = "";

            // Add lessons to sidebar
            if (
              lessonData.lessons &&
              Object.keys(lessonData.lessons).length > 0
            ) {
              Object.entries(lessonData.lessons).forEach(
                ([lessonId, lesson]) => {
                  const lessonTypeValue = lesson.type || "initial";
                  if (
                    lessonTypeValue === "initial" ||
                    lessonTypeValue === "all"
                  ) {
                    const li = document.createElement("li");
                    const a = document.createElement("a");
                    a.href = "#";
                    a.innerHTML = `<i class="fas fa-book"></i> ${lesson.title}`;
                    a.onclick = (e) => {
                      e.preventDefault();
                      document
                        .querySelectorAll("#initial-topics-nav a")
                        .forEach((link) => link.classList.remove("active"));
                      e.target.closest("a").classList.add("active");
                      displayInitialLesson(lesson);
                    };
                    li.appendChild(a);
                    navList.appendChild(li);
                  }
                }
              );
            }

            // Add videos to sidebar
            if (videoData.videos && Object.keys(videoData.videos).length > 0) {
              Object.entries(videoData.videos).forEach(([videoId, video]) => {
                const li = document.createElement("li");
                const a = document.createElement("a");
                a.href = "#";
                a.innerHTML = `<i class="fas fa-play"></i> ${
                  video.title || videoId
                }`;
                a.onclick = (e) => {
                  e.preventDefault();
                  document
                    .querySelectorAll("#initial-topics-nav a")
                    .forEach((link) => link.classList.remove("active"));
                  e.target.closest("a").classList.add("active");
                  displayInitialVideo(video, videoId);
                };
                li.appendChild(a);
                navList.appendChild(li);
              });
            }

            if (navList.children.length === 0) {
              navList.innerHTML =
                '<li><div class="no-content">No lessons or videos available for this topic.</div></li>';
            }
          })
          .catch((error) => {
            console.error("Error loading initial content:", error);
            navList.innerHTML =
              '<li><div class="error">Error loading content. Please try again.</div></li>';
          });
      }

      // Function to display lesson content
      function displayInitialLesson(lesson) {
        const contentDisplay = document.getElementById(
          "initial-content-display"
        );

        // Remove active class from all nav items and add to current
        document
          .querySelectorAll("#initial-topics-nav a")
          .forEach((a) => a.classList.remove("active"));

        // Parse lesson content if it's an array of content objects
        let lessonHTML = "";
        if (Array.isArray(lesson.content)) {
          lessonHTML = formatLessonContent(lesson.content);
        } else if (typeof lesson.content === "string") {
          lessonHTML = lesson.content;
        } else {
          lessonHTML = "<p>Lesson content not available.</p>";
        }

        contentDisplay.innerHTML = `
          <div class="lesson-content">
            <h2>${lesson.title}</h2>
            <div class="lesson-body">
              ${lessonHTML}
            </div>
            <div class="lesson-actions" style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
              <button onclick="markInitialLessonComplete('${lesson.lesson_id}')" class="action-button" style="background: #28a745;">
                <i class="fas fa-check"></i> Mark as Complete
              </button>
            </div>
          </div>
        `;
      }

      // Function to format structured lesson content
      function formatLessonContent(contentArray) {
        return contentArray
          .map((item) => {
            switch (item.type) {
              case "header":
                return `<h3>${processInlineCode(item.text)}</h3>`;
              case "paragraph":
                return `<p>${processInlineCode(item.text)}</p>`;
              case "code":
                return `<pre><code>${item.text}</code></pre>`;
              case "list":
                const listItems = item.items
                  .map((listItem) => `<li>${processInlineCode(listItem)}</li>`)
                  .join("");
                return `<ul>${listItems}</ul>`;
              default:
                return `<p>${processInlineCode(
                  item.text || JSON.stringify(item)
                )}</p>`;
            }
          })
          .join("");
      }

      // Helper function to process inline code marks (backticks)
      function processInlineCode(text) {
        if (!text) return text;
        // Replace `code` with <code>code</code>
        return text.replace(/`([^`]+)`/g, "<code>$1</code>");
      }

      // Function to display video content
      function displayInitialVideo(video, videoId) {
        const contentDisplay = document.getElementById(
          "initial-content-display"
        );

        // Remove active class from all nav items
        document
          .querySelectorAll("#initial-topics-nav a")
          .forEach((a) => a.classList.remove("active"));

        const embedUrl = video.url
          ? video.url.replace("watch?v=", "embed/")
          : "";

        contentDisplay.innerHTML = `
          <div class="video-content">
            <h2>${video.title || videoId}</h2>
            <div class="video-wrapper" style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
              <iframe 
                src="${embedUrl}" 
                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"
                frameborder="0" 
                allowfullscreen>
              </iframe>
            </div>
            <div class="video-description" style="margin-top: 20px;">
              ${
                video.description ||
                "<p>Watch this video to learn about the topic.</p>"
              }
            </div>
          </div>
        `;
      }

      // Function to go back to topics grid
      function backToTopicsFromInitial() {
        document.getElementById("initial-learning-layout").style.display =
          "none";
        document.querySelector(".topics-grid").style.display = "block";
      }

      // Function to mark lesson as complete (simplified for initial learning)
      function markInitialLessonComplete(lessonId) {
        fetch("/api/lesson-progress/mark-complete", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            subject: currentSubject,
            subtopic: currentSubtopic,
            lesson_id: lessonId,
          }),
        })
          .then((response) => {
            if (response.ok) {
              alert("Lesson marked as complete!");
            } else {
              alert("Error marking lesson as complete.");
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("Error marking lesson as complete.");
          });
      }

      function showLessonSelector(subject, subtopic) {
        currentSubject = subject;
        currentSubtopic = subtopic;
        document.getElementById(
          "lesson-modal-title"
        ).textContent = `Select Lesson Type - ${
          subtopic.charAt(0).toUpperCase() + subtopic.slice(1)
        }`;
        document.getElementById("lesson-modal").style.display = "flex";
        document.getElementById("lesson-list").style.display = "none";
        document.querySelector(".lesson-type-selector").style.display = "flex";
      }

      function closeLessonModal() {
        document.getElementById("lesson-modal").style.display = "none";
      }

      function showLessons(lessonType) {
        currentLessonType = lessonType;
        document.querySelector(".lesson-type-selector").style.display = "none";
        document.getElementById("lesson-list").style.display = "block";

        let typeTitle =
          lessonType === "remedial"
            ? "Remedial Lessons"
            : lessonType === "initial"
            ? "Initial Lessons"
            : "All Lessons";
        document.getElementById("lesson-list-title").textContent = typeTitle;

        loadLessons(currentSubject, currentSubtopic, lessonType);
      }

      function loadLessons(subject, subtopic, lessonType) {
        const lessonItems = document.getElementById("lesson-items");
        lessonItems.innerHTML = '<div class="loading">Loading lessons...</div>';

        // Load lessons directly from the subtopic's lesson_plans.json
        fetch(`/api/lesson-plans/${subject}/${subtopic}`)
          .then((response) => response.json())
          .then((data) => {
            if (data.lessons && Object.keys(data.lessons).length > 0) {
              // Filter lessons by type if specified
              const filteredLessons = [];
              Object.entries(data.lessons).forEach(([lessonId, lesson]) => {
                const lessonTypeValue = lesson.type || "remedial"; // Default to remedial if no type specified

                if (lessonType === "all" || lessonTypeValue === lessonType) {
                  filteredLessons.push({
                    lesson_id: lessonId,
                    title: lesson.title,
                    type: lessonTypeValue,
                    tags: lesson.tags || [],
                    subtopic: subtopic,
                    subject: subject,
                    content: lesson.content,
                    videoId: lesson.videoId,
                    completed: lesson.completed || false, // Include completion status
                  });
                }
              });

              if (filteredLessons.length > 0) {
                displayLessons(filteredLessons);
              } else {
                lessonItems.innerHTML = `
                  <div class="no-lessons">
                    <i class="fas fa-book" style="font-size: 48px; color: #ccc; margin-bottom: 15px;"></i>
                    <h3>No ${
                      lessonType === "all" ? "" : lessonType
                    } lessons found</h3>
                    <p>No ${
                      lessonType === "all" ? "" : lessonType + " "
                    }lessons are available for this topic yet.</p>
                  </div>
                `;
              }
            } else {
              lessonItems.innerHTML = `
                <div class="no-lessons">
                  <i class="fas fa-book" style="font-size: 48px; color: #ccc; margin-bottom: 15px;"></i>
                  <h3>No lessons found</h3>
                  <p>No lessons are available for this topic yet.</p>
                </div>
              `;
            }
          })
          .catch((error) => {
            console.error("Error loading lessons:", error);
            lessonItems.innerHTML = `
              <div class="error-message">
                <i class="fas fa-exclamation-triangle" style="color: #dc3545; margin-bottom: 10px;"></i>
                <p>Error loading lessons. Please try again.</p>
              </div>
            `;
          });
      }

      function displayLessons(lessons) {
        const lessonItems = document.getElementById("lesson-items");
        lessonItems.innerHTML = "";

        lessons.forEach((lesson) => {
          const lessonElement = document.createElement("div");
          lessonElement.className = "lesson-item";

          // Check if lesson is completed
          const isCompleted = lesson.completed || false;
          if (isCompleted) {
            lessonElement.classList.add("lesson-completed");
          }

          lessonElement.onclick = () => openLesson(lesson);

          const tags = lesson.tags
            ? lesson.tags
                .map((tag) => `<span class="lesson-tag">${tag}</span>`)
                .join("")
            : "";
          const lessonType = lesson.type || "remedial";
          const completionIcon = isCompleted
            ? '<i class="fas fa-check-circle lesson-completion-icon"></i>'
            : "";

          lessonElement.innerHTML = `
            <div class="lesson-item-header">
              <h4 class="lesson-item-title">${
                lesson.title
              } ${completionIcon}</h4>
              <span class="lesson-item-type ${lessonType}">${
            lessonType.charAt(0).toUpperCase() + lessonType.slice(1)
          }</span>
            </div>
            <div class="lesson-item-tags">${tags}</div>
          `;

          lessonItems.appendChild(lessonElement);
        });
      }

      function openLesson(lesson) {
        document.getElementById("lesson-modal").style.display = "none";
        document.getElementById("lesson-viewer-title").textContent =
          lesson.title;
        document.getElementById("lesson-viewer-modal").style.display = "flex";

        // Store current lesson for tracking
        currentLesson = lesson;

        renderLessonContent(lesson);
        checkLessonCompletion(lesson);
      }

      function loadLessonContent(lesson) {
        // This function is no longer needed since we pass the full lesson object
        renderLessonContent(lesson);
      }

      function renderLessonContent(lesson) {
        const lessonBody = document.getElementById("lesson-viewer-body");
        let contentHtml = "";

        // Add video if available
        if (lesson.videoId) {
          contentHtml += `
            <div class="lesson-video">
              <iframe width="100%" height="400" 
                      src="https://www.youtube.com/embed/${lesson.videoId}" 
                      frameborder="0" allowfullscreen>
              </iframe>
            </div>
          `;
        }

        // Add lesson content
        if (lesson.content && lesson.content.length > 0) {
          contentHtml += '<div class="lesson-content-blocks">';

          lesson.content.forEach((block) => {
            switch (block.type) {
              case "header":
                contentHtml += `<h3 class="content-header">${block.text}</h3>`;
                break;
              case "paragraph":
                contentHtml += `<p class="content-paragraph">${block.text}</p>`;
                break;
              case "code":
                contentHtml += `<pre class="content-code"><code>${block.text}</code></pre>`;
                break;
              case "list":
                const listItems = block.items
                  .map((item) => `<li>${item}</li>`)
                  .join("");
                contentHtml += `<ul class="content-list">${listItems}</ul>`;
                break;
              case "summary":
                contentHtml += `<div class="content-summary"><h4>Summary</h4><p>${block.text}</p></div>`;
                break;
              default:
                contentHtml += `<div class="content-block">${
                  block.text || ""
                }</div>`;
            }
          });

          contentHtml += "</div>";

          // Add completion section at the bottom
          contentHtml += `
            <div class="lesson-completion-section">
              <div class="lesson-completion-trigger" id="lesson-completion-trigger"></div>
              <div class="lesson-completion-actions">
                <button id="mark-complete-btn" class="mark-complete-btn" onclick="markLessonComplete()" style="display: none;">
                  <i class="fas fa-check"></i> Mark as Complete
                </button>
                <div id="lesson-completed-indicator" class="lesson-completed-indicator-bottom" style="display: none;">
                  <i class="fas fa-check-circle"></i> 
                  <span>Lesson Completed!</span>
                </div>
              </div>
            </div>
          `;
        } else {
          contentHtml +=
            '<div class="no-content">No content available for this lesson.</div>';
        }

        lessonBody.innerHTML = contentHtml;

        // Set up scroll-based completion tracking if lesson is not already completed
        if (!lesson.completed) {
          setupScrollTracking();
        }
      }

      function setupScrollTracking() {
        const lessonBody = document.getElementById("lesson-viewer-body");
        const completionTrigger = document.getElementById(
          "lesson-completion-trigger"
        );

        if (!completionTrigger) return;

        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (
                entry.isIntersecting &&
                currentLesson &&
                !currentLesson.completed
              ) {
                // User has scrolled to the bottom, suggest completion
                showCompletionSuggestion();
                observer.disconnect(); // Stop observing once triggered
              }
            });
          },
          { threshold: 1.0 }
        );

        observer.observe(completionTrigger);
      }

      function showCompletionSuggestion() {
        const markCompleteBtn = document.getElementById("mark-complete-btn");
        if (markCompleteBtn && markCompleteBtn.style.display !== "none") {
          // Highlight the button to draw attention
          markCompleteBtn.style.animation = "pulse 1s ease-in-out 3";
          markCompleteBtn.style.boxShadow = "0 0 15px rgba(40, 167, 69, 0.5)";

          // Show a tooltip-like message
          showNotification(
            "You've reached the end! Mark this lesson as complete.",
            "info"
          );
        }
      }

      function backToLessonList() {
        document.getElementById("lesson-viewer-modal").style.display = "none";
        document.getElementById("lesson-modal").style.display = "flex";
      }

      function closeLessonViewer() {
        document.getElementById("lesson-viewer-modal").style.display = "none";
      }

      function checkLessonCompletion(lesson) {
        // Check if current lesson is completed
        const isCompleted = lesson.completed || false;
        const markCompleteBtn = document.getElementById("mark-complete-btn");
        const completedIndicator = document.getElementById(
          "lesson-completed-indicator"
        );
        const completedIndicatorHeader = document.getElementById(
          "lesson-completed-indicator-header"
        );

        if (isCompleted) {
          if (markCompleteBtn) markCompleteBtn.style.display = "none";
          if (completedIndicator) completedIndicator.style.display = "flex";
          if (completedIndicatorHeader)
            completedIndicatorHeader.style.display = "flex";
        } else {
          if (markCompleteBtn) markCompleteBtn.style.display = "flex";
          if (completedIndicator) completedIndicator.style.display = "none";
          if (completedIndicatorHeader)
            completedIndicatorHeader.style.display = "none";
        }
      }

      async function markLessonComplete() {
        if (!currentLesson) return;

        try {
          const response = await fetch("/api/lesson-progress/mark-complete", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              subject: currentSubject,
              subtopic: currentSubtopic,
              lesson_id: currentLesson.lesson_id,
            }),
          });

          if (response.ok) {
            const result = await response.json();

            // Update UI to show completion
            const markCompleteBtn =
              document.getElementById("mark-complete-btn");
            const completedIndicator = document.getElementById(
              "lesson-completed-indicator"
            );
            const completedIndicatorHeader = document.getElementById(
              "lesson-completed-indicator-header"
            );

            if (markCompleteBtn) markCompleteBtn.style.display = "none";
            if (completedIndicator) completedIndicator.style.display = "flex";
            if (completedIndicatorHeader)
              completedIndicatorHeader.style.display = "flex";

            // Mark lesson as completed in current data
            currentLesson.completed = true;

            // Show success notification
            showNotification("Lesson marked as complete!", "success");

            // Update the subject page progress display
            updateSubtopicProgressAfterCompletion();

            // Update the lesson list display when user goes back
            setTimeout(() => {
              loadLessons(currentSubject, currentSubtopic, "initial");
            }, 1000);
          } else {
            throw new Error("Failed to mark lesson as complete");
          }
        } catch (error) {
          console.error("Error marking lesson complete:", error);
          showNotification("Error marking lesson as complete", "error");
        }
      }

      async function updateSubtopicProgressAfterCompletion() {
        try {
          const response = await fetch(
            `/api/lesson-progress/stats/${currentSubject}/${currentSubtopic}`
          );
          if (response.ok) {
            const stats = await response.json();
            updateSubtopicProgress(currentSubtopic, stats);
          }
        } catch (error) {
          console.error("Error updating subtopic progress:", error);
        }
      }

      // Close modals when clicking outside
      document.addEventListener("click", function (e) {
        if (e.target.id === "lesson-modal") {
          closeLessonModal();
        }
        if (e.target.id === "lesson-viewer-modal") {
          closeLessonViewer();
        }
      });

      // Load lesson progress for all subtopics on page load
      async function loadLessonProgress() {
        const subject = "{{ subject }}";

        // Get all subtopic elements
        const subtopicCards = document.querySelectorAll("[data-subtopic]");

        for (const card of subtopicCards) {
          const subtopic = card.getAttribute("data-subtopic");

          try {
            const response = await fetch(
              `/api/lesson-progress/stats/${subject}/${subtopic}`
            );
            if (response.ok) {
              const stats = await response.json();
              updateSubtopicProgress(subtopic, stats);
            }
          } catch (error) {
            console.error(`Error loading progress for ${subtopic}:`, error);
          }
        }
      }

      function updateSubtopicProgress(subtopic, stats) {
        const progressElement = document.getElementById(
          `${subtopic}-lesson-progress`
        );
        if (progressElement && stats.total_lessons > 0) {
          const progressText =
            stats.completed_lessons === stats.total_lessons
              ? `${stats.total_lessons} Lessons <span style="color: #28a745;">✓ Complete</span>`
              : `${stats.completed_lessons}/${stats.total_lessons} Lessons (${stats.completion_percentage}%)`;

          progressElement.innerHTML = progressText;
        }
      }

      function updateLessonProgressDisplay(progressData) {
        // This function is kept for compatibility but we now use the stats API
        // for more accurate and efficient progress tracking
      }

      function showNotification(message, type = "info") {
        // Remove existing notifications
        document.querySelectorAll(".notification").forEach((n) => n.remove());

        const notification = document.createElement("div");
        notification.className = `notification ${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
          if (notification.parentNode) {
            notification.remove();
          }
        }, 4000);
      }

      // Load progress when page loads
      document.addEventListener("DOMContentLoaded", function () {
        loadLessonProgress();

        // Add event listener for back to topics button
        document
          .getElementById("backToTopicsFromInitial")
          .addEventListener("click", backToTopicsFromInitial);
      });

      // Admin override functionality
      function toggleAdminOverride() {
        fetch("/admin/toggle-override", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              updateOverrideButton(data.admin_override);
              showNotification(
                data.message + " - Refreshing page...",
                "success"
              );

              // Refresh the page after a short delay to show the notification
              setTimeout(() => {
                window.location.reload();
              }, 1500);
            } else {
              showNotification("Error: " + data.error, "error");
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            showNotification("Error toggling admin override", "error");
          });
      }

      function updateOverrideButton(isActive) {
        const btn = document.getElementById("toggleOverrideBtn");
        const status = document.getElementById("overrideStatus");

        if (isActive) {
          btn.classList.add("override-active");
          status.textContent = "Disable Override";
        } else {
          btn.classList.remove("override-active");
          status.textContent = "Enable Override";
        }
      }

      // Notification system
      function showNotification(message, type = "info") {
        // Remove existing notifications
        document.querySelectorAll(".notification").forEach((n) => n.remove());

        const notification = document.createElement("div");
        notification.className = `notification notification-${type}`;
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 15px 20px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          z-index: 1000;
          animation: slideIn 0.3s ease-out;
          max-width: 350px;
          word-wrap: break-word;
        `;

        if (type === "success") {
          notification.style.background = "#d4edda";
          notification.style.color = "#155724";
          notification.style.border = "1px solid #c3e6cb";
        } else if (type === "error") {
          notification.style.background = "#f8d7da";
          notification.style.color = "#721c24";
          notification.style.border = "1px solid #f5c6cb";
        } else {
          notification.style.background = "#d1ecf1";
          notification.style.color = "#0c5460";
          notification.style.border = "1px solid #bee5eb";
        }

        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
          if (notification.parentNode) {
            notification.remove();
          }
        }, 4000);
      }

      // Check override status on page load
      document.addEventListener("DOMContentLoaded", function () {
        fetch("/admin/toggle-override", {
          method: "GET",
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              updateOverrideButton(data.admin_override);
            }
          })
          .catch((error) => {
            console.error("Error checking override status:", error);
          });
      });

      // Function to check quiz prerequisites
      function checkQuizPrerequisites(subject, subtopic) {
        fetch(`/api/quiz-prerequisites/${subject}/${subtopic}`)
          .then((response) => response.json())
          .then((data) => {
            if (data.all_met) {
              // Prerequisites met or admin override active, redirect to quiz
              window.location.href = `/quiz/${subject}/${subtopic}`;
            } else {
              // Prerequisites not met, show warning and redirect to prerequisites page
              const missingCount = data.missing_items.length;
              const message = `You need to complete ${missingCount} more requirement(s) before taking this quiz:\n\n${data.missing_items.join(
                "\n"
              )}`;

              if (
                confirm(
                  message + "\n\nWould you like to see the full requirements?"
                )
              ) {
                window.location.href = `/quiz/${subject}/${subtopic}`;
              }
            }
          })
          .catch((error) => {
            console.error("Error checking quiz prerequisites:", error);
            // On error, allow quiz access (fallback)
            window.location.href = `/quiz/${subject}/${subtopic}`;
          });
      }

      // Update quiz button status based on prerequisites
      function updateQuizButtonStatus() {
        const subject = "{{ subject }}";
        const subtopicElements = document.querySelectorAll('[id^="quiz-btn-"]');

        subtopicElements.forEach((button) => {
          const subtopic = button.id.replace("quiz-btn-", "");
          const statusIcon = document.getElementById(`quiz-status-${subtopic}`);
          const requirementsDiv = document.getElementById(
            `quiz-requirements-${subtopic}`
          );

          fetch(`/api/quiz-prerequisites/${subject}/${subtopic}`)
            .then((response) => response.json())
            .then((data) => {
              if (data.admin_override) {
                // Admin override active
                button.classList.remove("quiz-btn-disabled", "quiz-btn-ready");
                button.classList.add("quiz-btn-admin");
                button.title = "Admin Override Active - Quiz Unlocked";

                if (statusIcon) {
                  statusIcon.style.display = "flex";
                  statusIcon.className = "quiz-status-icon admin-override";
                  statusIcon.innerHTML = "⚡";
                }

                // Hide requirements when admin override is active
                if (requirementsDiv) {
                  requirementsDiv.style.display = "none";
                }
              } else if (data.all_met) {
                // All prerequisites met
                button.classList.remove("quiz-btn-disabled", "quiz-btn-admin");
                button.classList.add("quiz-btn-ready");
                button.title =
                  "All prerequisites completed. Ready to take quiz!";

                if (statusIcon) {
                  statusIcon.style.display = "flex";
                  statusIcon.className = "quiz-status-icon complete";
                  statusIcon.innerHTML = "✓";
                }

                // Update requirements display
                updateRequirementsDisplay(subtopic, data, true);
              } else {
                // Prerequisites not met
                button.classList.remove("quiz-btn-ready", "quiz-btn-admin");
                button.classList.add("quiz-btn-disabled");

                const missingCount = data.missing_items.length;
                const missingText = data.missing_items.join("\n• ");
                button.title = `Missing ${missingCount} requirement(s):\n• ${missingText}`;

                if (statusIcon) {
                  statusIcon.style.display = "flex";
                  statusIcon.className = "quiz-status-icon incomplete";
                  statusIcon.innerHTML = missingCount;
                }

                // Update requirements display
                updateRequirementsDisplay(subtopic, data, false);
              }
            })
            .catch((error) => {
              console.error(
                `Error checking prerequisites for ${subtopic}:`,
                error
              );
              // On error, allow quiz access (fallback)
              button.classList.remove("quiz-btn-disabled", "quiz-btn-admin");
              if (statusIcon) {
                statusIcon.style.display = "none";
              }
              if (requirementsDiv) {
                requirementsDiv.style.display = "none";
              }
            });
        });
      }

      // Update the requirements display
      function updateRequirementsDisplay(subtopic, data, allMet) {
        const requirementsDiv = document.getElementById(
          `quiz-requirements-${subtopic}`
        );
        if (!requirementsDiv) return;

        // Show requirements if not all met
        requirementsDiv.style.display = allMet ? "none" : "block";

        // Update lessons status
        const lessonsStatus = requirementsDiv.querySelector(".lessons-status");
        if (lessonsStatus) {
          lessonsStatus.className = `req-status ${
            data.lessons_complete ? "complete" : "incomplete"
          }`;
          lessonsStatus.innerHTML = data.lessons_complete ? "✓" : "✗";
        }

        // Update video status
        const videoStatus = requirementsDiv.querySelector(".video-status");
        if (videoStatus) {
          videoStatus.className = `req-status ${
            data.video_watched ? "complete" : "incomplete"
          }`;
          videoStatus.innerHTML = data.video_watched ? "✓" : "✗";
        }

        // Update icons
        const lessonsIcon = requirementsDiv.querySelector(".lessons-icon");
        if (lessonsIcon) {
          lessonsIcon.className = "req-icon lessons-icon fas fa-book";
        }

        const videoIcon = requirementsDiv.querySelector(".video-icon");
        if (videoIcon) {
          videoIcon.className = "req-icon video-icon fas fa-play";
        }
      }

      // Update quiz button status on page load and periodically
      updateQuizButtonStatus();
      setInterval(updateQuizButtonStatus, 30000); // Check every 30 seconds
    </script>

    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
  </body>
</html>
