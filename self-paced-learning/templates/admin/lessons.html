<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lessons Management - Admin Panel</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
  </head>
  <body class="admin-body">
    <div class="admin-layout">
      <nav class="admin-sidebar">
        <div class="admin-logo">
          <h2><i class="fas fa-cog"></i> Admin Panel</h2>
          <a href="/" class="back-to-site">? Back to Site</a>
        </div>

        <ul class="admin-nav">
          <li>
            <a href="/admin"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
          </li>
          <li>
            <a href="/admin/subjects"><i class="fas fa-book-open"></i> Subjects</a>
          </li>
          <li>
            <a href="/admin/subtopics/select-subject"><i class="fas fa-sitemap"></i> Subtopics</a>
          </li>
          <li>
            <a href="/admin/lessons/select-subject" class="active"
              ><i class="fas fa-chalkboard-teacher"></i> Lessons</a
            >
          </li>
          <li>
            <a href="/admin/questions/select-subject"
              ><i class="fas fa-question-circle"></i> Questions</a
            >
          </li>
          <li>
            <a href="/admin/export"
              ><i class="fas fa-download"></i> Export/Import</a
            >
          </li>
        </ul>
      </nav>

      <main class="admin-content">
        <header class="admin-header">
          {% if filtered_view %}
          <h1>
            Lessons for {{ subject_info.name or subject|title }} - {{
            subtopic|title }}
          </h1>
          <p>Manage lessons for this specific subtopic</p>
          <div class="breadcrumb">
            <a href="/admin/lessons/select-subject">All Lessons</a> >
            <a href="/admin/subjects"
              >{{ subject_info.name or subject|title }}</a
            >
            > {{ subtopic|title }}
          </div>
          {% else %}
          <h1>Lesson Management</h1>
          <p>Create and manage remedial and initial lessons for all subjects</p>
          {% endif %}
        </header>

        <!-- Actions Bar -->
        <div class="actions-bar">
          <div class="search-filter">
            <input
              type="text"
              id="lessonSearch"
              placeholder="Search lessons..."
              class="search-input"
            />
            {% if not filtered_view %}
            <select id="subjectFilter" class="filter-select">
              <option value="">All Subjects</option>
              {% for subject_id, subject_data in subjects.items() %}
              <option value="{{ subject_id }}">{{ subject_data.name }}</option>
              {% endfor %}
            </select>
            <select id="lessonTypeFilter" class="filter-select">
              <option value="">All Lesson Types</option>
              <option value="remedial">Remedial Lessons</option>
              <option value="initial">Initial Lessons</option>
            </select>
            {% endif %}
          </div>
          <div class="action-buttons">
            <div class="dropdown">
              <button
                class="action-btn primary dropdown-toggle"
                type="button"
                id="createDropdown"
                data-toggle="dropdown"
                aria-haspopup="true"
                aria-expanded="false"
              >
                <i class="fas fa-plus"></i> Create New Lesson
                <i class="fas fa-chevron-down"></i>
              </button>
              <div class="dropdown-menu" aria-labelledby="createDropdown">
                <a
                  class="dropdown-item"
                  href="/admin/lessons/create?type=remedial"
                >
                  <i class="fas fa-bandage"></i> Create Remedial Lesson
                </a>
                <a
                  class="dropdown-item"
                  href="/admin/lessons/create?type=initial"
                >
                  <i class="fas fa-seedling"></i> Create Initial Lesson
                </a>
              </div>
            </div>
            {% if filtered_view %}
            <a
              href="/admin/lessons/select-subject"
              class="action-btn secondary"
            >
              <i class="fas fa-list"></i> View All Lessons
            </a>
            {% endif %}
          </div>
        </div>

        <!-- Lessons Grid -->
        <div class="lessons-grid">
          {% if filtered_view %} 
            {% if lessons %}
              <!-- Lesson Type Sections -->
              {% set initial_lessons = lessons.items() | selectattr('1.type', 'equalto', 'initial') | list %}
              {% set remedial_lessons = lessons.items() | selectattr('1.type', 'ne', 'initial') | list %}
              
              <!-- Initial Lessons Section -->
              {% if initial_lessons %}
              <div class="lesson-section">
                <div class="section-header">
                  <h2><i class="fas fa-seedling"></i> Initial Lessons</h2>
                  <p>Foundational lessons that introduce core concepts - drag to reorder</p>
                </div>
                <div class="lessons-list" id="initial-lessons-list" data-subject="{{ subject }}" data-subtopic="{{ subtopic }}">
                  {% for lesson_id, lesson_data in initial_lessons %}
                  <div
                    class="lesson-card lesson-list-item initial-lesson draggable"
                    data-subject="{{ subject }}"
                    data-lesson-id="{{ lesson_id }}"
                    data-lesson-type="{{ lesson_data.type or 'initial' }}"
                    data-order="{{ lesson_data.order or loop.index }}"
                    draggable="true"
                  >
                    <div class="lesson-drag-handle">
                      <i class="fas fa-grip-vertical"></i>
                    </div>
                    
                    <div class="lesson-order-badge">
                      {{ lesson_data.order or loop.index }}
                    </div>

                    <div class="lesson-main-content">
                      <div class="lesson-header-inline">
                        <h3>{{ lesson_data.title }}</h3>
                        <div class="lesson-meta-inline">
                          <span
                            class="subject-badge-small"
                            style="background-color: {{ subject_info.color or '#007bff' }}"
                          >
                            <i class="{{ subject_info.icon or 'fas fa-book' }}"></i>
                          </span>
                          <span class="lesson-type-badge initial">
                            <i class="fas fa-seedling"></i> Initial
                          </span>
                        </div>
                      </div>

                      <div class="lesson-details">
                        {% if lesson_data.videoId %}
                        <div class="lesson-detail-item">
                          <i class="fas fa-video"></i>
                          <span>Video: {{ lesson_data.videoId }}</span>
                        </div>
                        {% endif %}

                        <div class="lesson-detail-item">
                          <i class="fas fa-list"></i>
                          <span>{{ lesson_data.content|length }} content blocks</span>
                        </div>

                        {% if lesson_data.tags %}
                        <div class="lesson-detail-item lesson-tags-inline">
                          <i class="fas fa-tags"></i>
                          <span>
                            {% for tag in lesson_data.tags %}
                            <span class="tag-small">{{ tag }}</span>
                            {% endfor %}
                          </span>
                        </div>
                        {% endif %}
                      </div>
                    </div>

                    <div class="lesson-actions-inline">
                      <a
                        href="/admin/lessons/{{ subject }}/{{ subtopic }}/{{ lesson_id }}/edit"
                        class="btn-action btn-edit"
                        title="Edit Lesson"
                      >
                        <i class="fas fa-edit"></i>
                      </a>
                      <button
                        class="btn-action btn-delete"
                        onclick="deleteLesson('{{ subject }}', '{{ subtopic }}', '{{ lesson_id }}')"
                        title="Delete Lesson"
                      >
                        <i class="fas fa-trash"></i>
                      </button>
                      <a
                        href="/subjects/{{ subject }}?subtopic={{ subtopic }}&lesson={{ lesson_id }}"
                        target="_blank"
                        class="btn-action btn-view"
                        title="Preview Lesson"
                      >
                        <i class="fas}}
