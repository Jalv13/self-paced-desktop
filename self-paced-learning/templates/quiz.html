<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>{{ quiz_title or "Quiz" }}</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/styles.css') }}"
    />
  </head>
  <body class="quiz-page">
    {% if admin_override %}
    <div class="admin-controls">
      <div class="admin-panel">
        <div class="admin-info">
          <i class="fas fa-shield-alt"></i>
          <span>Admin Override Active</span>
        </div>
        <button
          id="toggleOverride"
          class="btn-override"
          onclick="toggleAdminOverride()"
        >
          <i class="fas fa-power-off"></i>
          Disable Override
        </button>
      </div>
    </div>
    {% endif %} {% if admin_override %}
    <div class="admin-override-notice">
      <i class="fas fa-exclamation-triangle"></i>
      <strong>Admin Override Active:</strong> Correct answers are highlighted in
      green for testing purposes.
    </div>
    {% endif %}

    <h1>{{ quiz_title or "Quiz" }}</h1>
    <form id="quiz-form" class="quiz-form">
      {% for q in questions %} {% set idx = loop.index0 %}
      <div class="question">
        <p>
          <strong
            >{{ loop.index }}. {# Check if the question is fill-in-the-blank to
            render the input inline #} {% if q.type == 'fill_in_the_blank' %} {{
            q.question.split('____')[0] | safe }}
            <input
              type="text"
              name="q{{ idx }}"
              class="inline-input"
              required
              autocomplete="off"
            />
            {{ q.question.split('____')[1] | safe }}
            <span class="question-type-indicator fill-blank"
              >Fill in Blank</span
            >
            {% elif q.type == 'coding' %} {{ q.question }}
            <span class="question-type-indicator coding">Coding</span>
            {% else %} {# Otherwise, display the question text normally for
            multiple choice #} {{ q.question }}
            <span class="question-type-indicator multiple-choice"
              >Multiple Choice</span
            >
            {% endif %}
          </strong>
        </p>

        {# --- MULTIPLE CHOICE (default if no type specified) --- #} {% if
        q.type == 'multiple_choice' or not q.type %} {% for option in q.options
        %}
        <label
          class="{% if admin_override and loop.index0 == q.answer_index %}correct-answer{% endif %}"
        >
          <input type="radio" name="q{{ idx }}" value="{{ option }}" required />
          {{ option }} {% if admin_override and loop.index0 == q.answer_index %}
          <i class="fas fa-check-circle correct-indicator"></i>
          {% endif %}
        </label>
        {% endfor %} {# --- CODING QUESTION --- #} {% elif q.type == 'coding' %}
        <textarea
          name="q{{ idx }}"
          placeholder="Write your Python code here..."
          required
        >
{{ q.starter_code or '' }}</textarea
        >

        {# --- FILL IN THE BLANK --- #} {% elif q.type == 'fill_in_the_blank' %}
        {# Fill-in-the-blank input is already handled above in the question text
        #} {% endif %}
      </div>
      {% endfor %}
      <button type="submit" class="quiz-submit-button">Submit Quiz</button>
    </form>

    <div id="quiz-feedback-panel" class="quiz-feedback hidden">
      <div class="quiz-feedback__score">
        <div class="score-ring">
          <span id="immediate-score">--%</span>
        </div>
        <p class="score-caption">Rule-based score</p>
      </div>
      <div class="quiz-feedback__details">
        <p id="immediate-feedback" class="feedback-text">
          Immediate feedback will appear here after submission.
        </p>
        <ul id="weak-topics-list" class="weak-topics-list"></ul>
        <div id="analysis-progress" class="analysis-progress">
          <span class="progress-chip" data-progress-step="score">Score</span>
          <span class="progress-chip" data-progress-step="weak">Weak Areas</span>
          <span class="progress-chip" data-progress-step="ai">AI Insights</span>
        </div>
        <div id="ai-status" class="ai-status">
          <span class="spinner" aria-hidden="true"></span>
          <span id="ai-status-text">Analyzing question patterns...</span>
        </div>
        <div id="redirect-notice" class="redirect-notice hidden">
          Redirecting to detailed results...
        </div>
      </div>
    </div>

    <script>
      // Add click handlers for visual feedback
      document.addEventListener("DOMContentLoaded", function () {
        // Add click event listeners to all labels
        const labels = document.querySelectorAll(".question label");
        labels.forEach((label) => {
          label.addEventListener("click", function () {
            // Find the question container
            const questionDiv = this.closest(".question");

            // Remove selected class from all labels in this question
            questionDiv.querySelectorAll("label").forEach((l) => {
              l.classList.remove("selected");
            });

            // Add selected class to clicked label
            this.classList.add("selected");
          });
        });
      });

      document
        .getElementById("quiz-form")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          // Get the submit button and disable it immediately
          const submitButton = e.target.querySelector(".quiz-submit-button");
          const originalText = submitButton.textContent;

          // Disable button and show processing state
          submitButton.disabled = true;
          submitButton.textContent = "Submitting...";
          submitButton.classList.add("disabled");

          const formData = new FormData(e.target);
          const responses = {};

          for (const [name, value] of formData.entries()) {
            responses[name] = value;
          }

          try {
            const analyzeResponse = await fetch("/analyze", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ answers: responses }),
            });

            if (!analyzeResponse.ok) {
              throw new Error(`Analysis failed with status ${analyzeResponse.status}`);
            }

            const analyzePayload = await analyzeResponse.json();
            if (!analyzePayload.success) {
              throw new Error(analyzePayload.error || "Analysis request unsuccessful");
            }

            displayBasicAnalysis(analyzePayload.analysis || {});

            // Kick off async enhancement (fire and forget)
            try {
              await fetch("/analyze/enhance", { method: "POST" });
              setProgressState("ai");
            } catch (enhanceError) {
              console.warn("Unable to trigger AI enhancement:", enhanceError);
              setAiStatus("AI enhancement unavailable. Showing basic results.", true);
            }

            redirectNotice.classList.remove("hidden");
            redirectNotice.textContent = "Redirecting to detailed results...";

            setTimeout(() => {
              window.location.href = "/results";
            }, 1500);
          } catch (error) {
            console.error("Error during analysis:", error);
            alert("Quiz analysis failed. Please try again.");
            submitButton.disabled = false;
            submitButton.textContent = originalText;
            submitButton.classList.remove("disabled");
            feedbackPanel.classList.add("hidden");
          }
        });

      const feedbackPanel = document.getElementById("quiz-feedback-panel");
      const immediateScore = document.getElementById("immediate-score");
      const immediateFeedback = document.getElementById("immediate-feedback");
      const weakTopicsList = document.getElementById("weak-topics-list");
      const progressChips = document.querySelectorAll(
        ".progress-chip[data-progress-step]"
      );
      const aiStatusText = document.getElementById("ai-status-text");
      const aiStatusContainer = document.getElementById("ai-status");
      const redirectNotice = document.getElementById("redirect-notice");

      function displayBasicAnalysis(analysis) {
        if (!analysis) return;
        feedbackPanel.classList.remove("hidden");
        redirectNotice.classList.add("hidden");
        setAiStatus("Analyzing question patterns...");
        animateScore(analysis?.score?.percentage ?? 0);
        immediateFeedback.textContent =
          analysis.basic_feedback || analysis.feedback || "Great work!";
        renderWeakTopics(analysis.weak_tags || analysis.weak_topics || []);
        setProgressState("score");
        setTimeout(() => setProgressState("weak"), 250);
      }

      function animateScore(targetScore) {
        const start = 0;
        const duration = 600;
        const startTime = performance.now();

        function update(now) {
          const elapsed = now - startTime;
          const progress = Math.min(elapsed / duration, 1);
          const value = Math.round(start + (targetScore - start) * progress);
          immediateScore.textContent = `${value}%`;
          if (progress < 1) {
            requestAnimationFrame(update);
          } else {
            setProgressState("weak");
            setAiStatus("Enhancing analysis with AI...");
          }
        }

        requestAnimationFrame(update);
      }

      function renderWeakTopics(topics) {
        weakTopicsList.innerHTML = "";
        if (!topics || topics.length === 0) {
          const li = document.createElement("li");
          li.textContent = "No weak areas detected. Great job!";
          li.classList.add("all-clear");
          weakTopicsList.appendChild(li);
          return;
        }

        topics.slice(0, 5).forEach((topic) => {
          const li = document.createElement("li");
          li.textContent = topic;
          weakTopicsList.appendChild(li);
        });
      }

      function setProgressState(step) {
        progressChips.forEach((chip) => {
          const chipStep = chip.dataset.progressStep;
          if (chipStep === step || chip.classList.contains("completed")) {
            chip.classList.add("completed");
          }
        });
      }

      function setAiStatus(message, isWarning = false) {
        aiStatusText.textContent = message;
        if (isWarning) {
          aiStatusContainer.classList.add("warning");
        } else {
          aiStatusContainer.classList.remove("warning");
        }
      }

      // Admin override functionality
      function toggleAdminOverride() {
        fetch("/admin/toggle-override", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              // Reload page to reflect new override state
              window.location.reload();
            } else {
              alert("Error toggling admin override: " + data.error);
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("Error toggling admin override");
          });
      }
    </script>

    <style>
      .admin-controls {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
      }

      .admin-panel {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 12px 20px;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        gap: 15px;
        backdrop-filter: blur(10px);
      }

      .admin-info {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        font-size: 14px;
      }

      .admin-info i {
        color: #ffd700;
      }

      .btn-override {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.3s ease;
      }

      .btn-override:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-1px);
      }

      @media (max-width: 768px) {
        .admin-controls {
          top: 10px;
          right: 10px;
        }

        .admin-panel {
          padding: 10px 15px;
          flex-direction: column;
          gap: 10px;
        }

        .admin-info {
          font-size: 12px;
        }

        .btn-override {
          font-size: 11px;
          padding: 5px 10px;
        }
      }

      /* Correct answer highlighting */
      .correct-answer {
        background-color: #d4edda !important;
        border: 2px solid #28a745 !important;
        color: #155724 !important;
        position: relative;
      }

      .correct-answer:hover {
        background-color: #c3e6cb !important;
      }

      .correct-indicator {
        color: #28a745;
        margin-left: 10px;
        font-size: 1.1em;
      }

      .admin-override-notice {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        color: #856404;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .admin-override-notice i {
        color: #ffc107;
        font-size: 1.2em;
      }

      .quiz-feedback {
        margin-top: 30px;
        padding: 20px;
        border-radius: 16px;
        background: #f4f6fb;
        display: flex;
        gap: 24px;
        align-items: center;
        box-shadow: 0 15px 45px rgba(15, 23, 42, 0.08);
      }

      .quiz-feedback.hidden {
        display: none;
      }

      .quiz-feedback__score {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
      }

      .score-ring {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background: radial-gradient(circle at top, #4f46e5, #312e81);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 28px;
        font-weight: 700;
        box-shadow: inset 0 0 0 6px rgba(255, 255, 255, 0.2);
      }

      .score-caption {
        font-size: 14px;
        color: #4b5563;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .quiz-feedback__details {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .feedback-text {
        font-size: 16px;
        font-weight: 500;
        color: #1f2937;
      }

      .weak-topics-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .weak-topics-list li {
        background: #eef2ff;
        color: #312e81;
        padding: 6px 12px;
        border-radius: 9999px;
        font-size: 13px;
        font-weight: 600;
      }

      .weak-topics-list li.all-clear {
        background: #dcfce7;
        color: #166534;
      }

      .analysis-progress {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }

      .progress-chip {
        background: #e5e7eb;
        color: #374151;
        padding: 6px 14px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .progress-chip.completed {
        background: #4f46e5;
        color: #fff;
      }

      .progress-chip.completed::after {
        content: "✓";
        font-size: 12px;
      }

      .ai-status {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 14px;
        color: #4b5563;
      }

      .ai-status.warning {
        color: #b91c1c;
      }

      .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid rgba(99, 102, 241, 0.3);
        border-top-color: #4f46e5;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      .redirect-notice {
        font-size: 13px;
        color: #2563eb;
        font-weight: 600;
      }

      .redirect-notice.hidden {
        display: none;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      @media (max-width: 768px) {
        .quiz-feedback {
          flex-direction: column;
          align-items: flex-start;
        }

        .score-ring {
          width: 90px;
          height: 90px;
          font-size: 22px;
        }
      }

      /* Disabled button styles */
      .quiz-submit-button.disabled {
        background-color: #6c757d !important;
        border-color: #6c757d !important;
        color: #ffffff !important;
        cursor: not-allowed !important;
        opacity: 0.65 !important;
        pointer-events: none !important;
      }

      .quiz-submit-button:disabled {
        background-color: #6c757d !important;
        border-color: #6c757d !important;
        color: #ffffff !important;
        cursor: not-allowed !important;
        opacity: 0.65 !important;
        pointer-events: none !important;
      }
    </style>
  </body>
</html>
