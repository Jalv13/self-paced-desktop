<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quiz Analysis Results</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/styles.css') }}"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <!-- Pyodide for Python code execution -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
    <!-- Markdown rendering and sanitization -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>
  <body>
    {% if admin_override %}
    <div
      class="admin-override-panel admin-override-panel-inline"
      id="resultsAdminOverridePanel"
    >
      <div class="admin-override-label">Admin Override Active</div>
    </div>
    {% endif %}
    <div class="blackboard-layout">
      <nav id="results-sidebar" class="sidebar">
        <div class="sidebar-header">
          <h2>Remedial Learning</h2>
          <p>Targeted lessons for your weak areas identified by AI analysis.</p>
        </div>

        <ul id="weak-topics-nav" class="topic-nav-list"></ul>

        <div class="sidebar-footer">
          {% if is_admin %}
          <button
            id="adminMarkCompleteButton"
            class="admin-action-button"
            type="button"
          >
            Admin: Mark All Complete
          </button>
          {% endif %}
          <button id="continueButton" class="action-button hidden" disabled>
            Take Follow-up Quiz
          </button>
          <a
            href="{{ url_for('main.subject_page', subject=CURRENT_SUBJECT) if CURRENT_SUBJECT else url_for('main.subject_selection') }}"
            id="backToTopicsButton"
            class="action-button hidden"
            >Back to {{ CURRENT_SUBJECT.title() if CURRENT_SUBJECT else
            'Subject' }} Topics</a
          >
        </div>
      </nav>

      <main id="lesson-content-area" class="content-area">
        <!-- This area displays remedial lesson content and videos for identified weak topics -->
        <div id="content-display">
          <div id="status" class="status status-loading">
            Analzing your submission, please wait...
          </div>

          <!-- Score Display Container -->
          <div id="score-container" class="score-container hidden">
            <h3>Your Quiz Score</h3>
            <div id="score-display" class="score-display">--</div>
            <div id="score-details" class="score-details">
              <span id="correct-count">0</span> out of
              <span id="total-count">0</span> questions correct
            </div>
          </div>

          {% if quiz_generation_error %}
          <div id="quiz-generation-error-message" class="status status-error">
            <strong>Error:</strong> {{ quiz_generation_error }}
          </div>
          {% endif %}

          <div id="mastery-message-container" class="hidden">
            <h2>All Clear!</h2>
            <p>Congratulations! No specific weak areas were identified.</p>
          </div>

          <div id="welcome-message" class="hidden">
            <h2>AI Feedback & Analysis</h2>
            <div id="feedback-content" class="feedback-content"></div>
            <p class="call-to-action">
              Select a lesson to read or a video to watch from the left.
            </p>
          </div>
        </div>
      </main>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
      const REMEDIAL_LESSON_PLANS = {{ LESSON_PLANS | tojson | safe }};
      const VIDEO_DATA = {{ VIDEO_DATA | tojson | safe }};
      const CURRENT_SUBJECT = {{ CURRENT_SUBJECT | tojson | safe }};
      const CURRENT_SUBTOPIC = {{ CURRENT_SUBTOPIC | tojson | safe }};
      const ANALYSIS_RESULTS = {{ ANALYSIS_RESULTS | tojson | safe }};

      const MARKDOWN_OPTIONS = {
        mangle: false,
        headerIds: false,
        breaks: true,
      };

      function escapeHtml(value) {
        return String(value ?? "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function hasMarkdownSupport() {
        return (
          typeof window !== "undefined" &&
          typeof window.DOMPurify !== "undefined" &&
          typeof window.marked !== "undefined"
        );
      }

      function renderInlineMarkdown(text) {
        const rawText = String(text ?? "");
        if (!rawText) {
          return "";
        }

        if (!hasMarkdownSupport()) {
          return escapeHtml(rawText);
        }

        const rendered = window.marked.parseInline(rawText, MARKDOWN_OPTIONS);
        return window.DOMPurify.sanitize(rendered);
      }

      function renderBlockMarkdown(text) {
        const rawText = String(text ?? "");
        if (!rawText) {
          return "";
        }

        if (!hasMarkdownSupport()) {
          return `<p>${escapeHtml(rawText)}</p>`;
        }

        const rendered = window.marked.parse(rawText, MARKDOWN_OPTIONS);
        return window.DOMPurify.sanitize(rendered);
      }
    </script>

    <script>
            window.addEventListener("DOMContentLoaded", async function () {
              // --- Element References ---
              const statusDiv = document.getElementById("status");
              const scoreContainer = document.getElementById("score-container");
              const scoreDisplay = document.getElementById("score-display");
              const scoreDetails = document.getElementById("score-details");
              const correctCount = document.getElementById("correct-count");
              const totalCount = document.getElementById("total-count");
              const masteryMessageContainer = document.getElementById(
                "mastery-message-container"
              );
              const welcomeMessageContainer =
                document.getElementById("welcome-message");
              const feedbackContentDiv = document.getElementById("feedback-content");
              const topicsNavList = document.getElementById("weak-topics-nav");
              const contentDisplayArea = document.getElementById("content-display");
              const continueButton = document.getElementById("continueButton");
              const backToTopicsButton =
                document.getElementById("backToTopicsButton");
              const adminMarkCompleteButton = document.getElementById(
                "adminMarkCompleteButton"
              );

              // --- State Tracking ---
              let completionState = {};
              const videoLookupCache = new Map();
              let currentPlayer = null;
              let currentVideoTopic = null;
              let videoProgressChecker = null;

              // --- YouTube API Ready Handler ---
              window.onYouTubeIframeAPIReady = function () {
                console.log("YouTube Player API is ready.");
              };

              // --- Main Analysis Logic - Use Flask session data instead of sessionStorage ---
              console.log("Processing analysis results from Flask session");

              if (!ANALYSIS_RESULTS) {
                statusDiv.textContent =
                  "No quiz analysis found. Please take a quiz first.";
                statusDiv.className = "status status-error";
                backToTopicsButton.classList.remove("hidden");
                return;
              }

              // Process the analysis results immediately
              statusDiv.textContent = "Analysis complete!";
              statusDiv.className = "status status-success";

              await processAnalysisResults(ANALYSIS_RESULTS);

              // --- Helper Functions ---
              function resolveLesson(keyOrId) {
                if (!keyOrId) return null;
                const k = String(keyOrId);
                return REMEDIAL_LESSON_PLANS && REMEDIAL_LESSON_PLANS[k]
                  ? REMEDIAL_LESSON_PLANS[k]
                  : null;
              }

              function extractVideoIdFromUrl(url) {
                const regExp =
                  /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
                const match = url.match(regExp);
                return match && match[2].length === 11 ? match[2] : null;
              }

              // Map conceptual topics to actual video keys
              function getVideoKeyForTopic(topic) {
                const topicMappings = {
                  "keyword arguments": "functions",
                  "function parameters": "functions",
                  "function arguments": "functions",
                  "parameter passing": "functions",
                  "default parameters": "functions",
                  "function definition": "functions",
                  "function calls": "functions",
                  "return statements": "functions",
                  "function scope": "functions",
                  "for loops": "loops",
                  "while loops": "loops",
                  "loop iteration": "loops",
                  "break statements": "loops",
                  "continue statements": "loops",
                  "nested loops": "loops",
                  "list operations": "lists",
                  "list methods": "lists",
                  "list comprehension": "lists",
                  "list indexing": "lists",
                  "array operations": "arrays",
                  "numpy arrays": "arrays",
                  "set operations": "sets",
                  "dictionary operations": "dictionaries",
                  "dict methods": "dictionaries",
                };

                const normalizedTopic = topic.toLowerCase();
                return topicMappings[normalizedTopic] || topic;
              }

              function lookupVideoData(topic, completionKey) {
                if (!VIDEO_DATA || typeof VIDEO_DATA !== "object") {
                  return null;
                }

                const cacheKey = `${topic || ""}::${completionKey || ""}`;
                if (videoLookupCache.has(cacheKey)) {
                  return videoLookupCache.get(cacheKey);
                }

                const normalizedTopic = (topic || "").trim();
                const normalizedCompletion = (completionKey || normalizedTopic).trim();

                const candidateKeys = [];
                const pushCandidate = (key) => {
                  if (!key) return;
                  const keyString = String(key).trim();
                  if (!keyString) return;
                  if (!candidateKeys.includes(keyString)) {
                    candidateKeys.push(keyString);
                  }
                };

                pushCandidate(getVideoKeyForTopic(normalizedCompletion));
                pushCandidate(getVideoKeyForTopic(normalizedTopic));
                pushCandidate(normalizedCompletion);
                pushCandidate(normalizedTopic);

                const lowerTopic = normalizedTopic.toLowerCase();
                const lowerCompletion = normalizedCompletion.toLowerCase();
                if (
                  lowerTopic.includes("function") ||
                  lowerTopic.includes("parameter") ||
                  lowerTopic.includes("argument") ||
                  lowerCompletion.includes("function") ||
                  lowerCompletion.includes("parameter") ||
                  lowerCompletion.includes("argument")
                ) {
                  pushCandidate("functions");
                }

                let found = null;
                for (const key of candidateKeys) {
                  if (VIDEO_DATA[key]) {
                    found = { key, data: VIDEO_DATA[key] };
                    break;
                  }
                }

                videoLookupCache.set(cacheKey, found);
                return found;
              }

              // --- Simplified Click Handler ---
              document.addEventListener("click", function (e) {
                const link = e.target.closest("a[data-action]");
                if (!link) return;

                e.preventDefault();
                const action = link.dataset.action;
                const topic = link.dataset.topic;
                const weakTopic = link.dataset.weakTopic;
                const completionKey = weakTopic || topic;

                if (!topic || !action) return;

                // Clear previous active state
                const currentActive = document.querySelector("a.active");
                if (currentActive) currentActive.classList.remove("active");
                link.classList.add("active");

                if (action === "read") {
                  renderLesson(topic);
                  updateCompletionState(completionKey, "read");
                } else if (action === "watch") {
                  renderVideo(topic, completionKey);
                }
              });

              // --- Analysis Results Processing Function ---
              async function processAnalysisResults(analysisData) {
                console.log("Processing analysis results:", analysisData);

                const weakTopics =
                  (analysisData.weak_topics && analysisData.weak_topics.length
                    ? analysisData.weak_topics
                    : analysisData.weak_tags) || [];

                // Calculate and display score
                if (analysisData.score) {
                  displayScore(analysisData.score);
                }

                statusDiv.classList.add("hidden");

                if (weakTopics.length > 0) {
                  welcomeMessageContainer.classList.remove("hidden");
                  const feedbackHtml = renderBlockMarkdown(
                    analysisData.feedback || ""
                  );
                  feedbackContentDiv.innerHTML = feedbackHtml;

                  buildCompletionState(weakTopics);
                  displayWeakTopics(weakTopics);

                  continueButton.classList.remove("hidden");
                  backToTopicsButton.classList.remove("hidden");
                  checkCompletionAndToggleButton();
                } else {
                  masteryMessageContainer.classList.remove("hidden");
                  backToTopicsButton.classList.remove("hidden");
                  // Show continue button for perfect scores too
                  continueButton.classList.remove("hidden");
                  continueButton.disabled = false; // Enable button when no weak topics
                }
              }

              // --- Simplified Topic Display ---
              function displayWeakTopics(topics) {
                topicsNavList.innerHTML = "";
                topics.forEach((topic) => {
                  const lesson = REMEDIAL_LESSON_PLANS[topic];
                  if (!lesson) return;

                  const safeTopicId = topic.replace(/[^a-zA-Z0-9]/g, "_");
                  const hasVideo = Boolean(lookupVideoData(topic));
                  const topicAttr = escapeHtml(topic);
                  const displayTitle = renderInlineMarkdown(lesson.title || topic);
                  const groupLi = document.createElement("li");
                  groupLi.className = "topic-group";
                  groupLi.innerHTML = `
                   <span>${displayTitle || escapeHtml(lesson.title || topic)}</span>
                   <ul>
                     <li id="read-${safeTopicId}"><a href="#" data-topic="${topicAttr}" data-weak-topic="${topicAttr}" data-action="read">Read Remedial Lesson</a></li>
                     ${
                       hasVideo
                         ? `<li id="watch-${safeTopicId}"><a href="#" data-topic="${topicAttr}" data-weak-topic="${topicAttr}" data-action="watch">Watch Video</a></li>`
                         : ""
                     }
                   </ul>
                 `;
                  topicsNavList.appendChild(groupLi);
                });
              }

              // --- Helper Functions ---
              function buildCompletionState(topics) {
                completionState = {};
                topics.forEach((topic) => {
                  const state = { read: false };
                  const videoInfo = lookupVideoData(topic);
                  if (videoInfo && videoInfo.data) {
                    state.watched = false;
                  }
                  completionState[topic] = state;
                });
              }

              // --- Score Display Function ---
              function displayScore(scoreData) {
                const { correct, total, percentage } = scoreData;

                // Update score display
                scoreDisplay.textContent = `${percentage}%`;
                correctCount.textContent = correct;
                totalCount.textContent = total;

                // Apply score-based styling
                scoreContainer.classList.remove(
                  "score-excellent",
                  "score-good",
                  "score-needs-improvement"
                );
                if (percentage >= 90) {
                  scoreContainer.classList.add("score-excellent");
                } else if (percentage >= 70) {
                  scoreContainer.classList.add("score-good");
                } else {
                  scoreContainer.classList.add("score-needs-improvement");
                }

                // Show the score container
                scoreContainer.classList.remove("hidden");
              }

              // --- Score Display Function (duplicate click handler removed) ---

              continueButton.addEventListener("click", async function (event) {
                event.preventDefault();
                if (this.disabled) {
                  return;
                }

                const originalText = this.textContent;
                this.disabled = true;
                this.textContent = "Loading...";

                try {
                  const response = await fetch("/generate_remedial_quiz", {
                    headers: {
                      Accept: "application/json",
                    },
                    credentials: "same-origin",
                  });

                  if (!response.ok) {
                    throw new Error(`Request failed with status ${response.status}`);
                  }

                  const data = await response.json();

                  if (data.success && data.redirect_url) {
                    window.location.href = data.redirect_url;
                    return;
                  }

                  const errorMessage =
                    (data && (data.error || data.message)) ||
                    "Unable to start the follow-up quiz. Please review the lessons and try again.";
                  alert(errorMessage);
                } catch (error) {
                  console.error("Error starting remedial quiz:", error);
                  alert("We couldn't start the follow-up quiz. Please try again.");
                }

                this.disabled = false;
                this.textContent = originalText;
              });

              // Admin mark complete functionality
              if (adminMarkCompleteButton) {
                adminMarkCompleteButton.addEventListener("click", async function () {
                  if (
                    !confirm(
                      "Mark all weak topics as complete? This will set all read and watch activities to 100% completion."
                    )
                  ) {
                    return;
                  }

                  if (!CURRENT_SUBJECT || !CURRENT_SUBTOPIC) {
                    alert("Unable to determine the active subject and subtopic.");
                    return;
                  }

                  try {
                    const response = await fetch("/api/admin/mark_complete", {
                      method: "POST",
                      headers: {
                        "Content-Type": "application/json",
                      },
                      body: JSON.stringify({
                        subject: CURRENT_SUBJECT,
                        subtopic: CURRENT_SUBTOPIC,
                      }),
                    });

                    const payload = await response.json().catch(() => ({}));

                    if (!response.ok || !payload.success) {
                      throw new Error(payload.error || "Failed to mark topic as complete");
                    }

                    // Update local completion state for all weak topics
                    const weakTopics = Object.keys(completionState);
                    weakTopics.forEach((topic) => {
                      if (!completionState[topic]) {
                        completionState[topic] = {};
                      }

                      const state = completionState[topic];

                      const safeTopicId = topic.replace(/[^a-zA-Z0-9]/g, "_");

                      if ("read" in state) {
                        state.read = true;
                        const readElement = document.getElementById(`read-${safeTopicId}`);
                        if (readElement) {
                          readElement.classList.add("completed");
                        }
                      }

                      if ("watched" in state) {
                        state.watched = true;
                        const watchElement = document.getElementById(`watch-${safeTopicId}`);
                        if (watchElement) {
                          watchElement.classList.add("completed");
                        }
                      }
                    });

                    alert(payload.message || "Successfully marked this topic as complete.");

                    checkCompletionAndToggleButton();
                  } catch (error) {
                    console.error("Error marking topics complete:", error);
                    alert("Error marking topics complete. Please try again.");
                  }
                });
              }

              function processInlineCode(text) {
                return renderInlineMarkdown(text);
              }

              function formatLessonContent(contentArray) {
                return (contentArray || [])
                  .map((item) => {
                    switch (item.type) {
                      case "header": {
                        const headerHtml = processInlineCode(item.text);
                        return headerHtml ? `<h3>${headerHtml}</h3>` : "";
                      }
                      case "paragraph": {
                        const paragraphHtml = renderBlockMarkdown(item.text);
                        return paragraphHtml || "";
                      }
                      case "code": {
                        const escapedCode = escapeHtml(item.text || "");
                        return `<pre><code>${escapedCode}</code></pre>`;
                      }
                      case "list": {
                        const listItems = (item.items || [])
                          .map((listItem) => {
                            const listHtml = processInlineCode(listItem);
                            return listHtml ? `<li>${listHtml}</li>` : "";
                          })
                          .join("");
                        return listItems ? `<ul>${listItems}</ul>` : "";
                      }
                      case "code_runner":
                        const blockId = Math.random().toString(36).substr(2, 9);
                        const starterCode = escapeHtml(
                          item.starter_code ||
                            '# Write your Python code here\nprint("Hello, World!")'
                        );
                        const expectedOutput = escapeHtml(item.expected_output || "");
                        const hintsHtml = (item.hints || [])
                          .map((hint) => {
                            const hintHtml = processInlineCode(hint);
                            return hintHtml ? `<li>${hintHtml}</li>` : "";
                          })
                          .join("");
                        const solutionHtml = escapeHtml(item.solution || "");
                        return `
                          <div class="code-runner-block" id="code-runner-${blockId}">
                            <div class="code-runner-header">
                              <h4><i class="fas fa-play-circle"></i> Interactive Python Code</h4>
                              <button class="code-runner-toggle" type="button" onclick="expandCodeRunner('${blockId}')" aria-expanded="false" aria-label="Expand code runner">
                                <i class="fas fa-expand-alt"></i>
                              </button>
                            </div>
                            <div class="code-runner-content">
                              <div class="code-editor">
                                <textarea id="code-editor-${blockId}" class="python-editor" placeholder="Write your Python code here...">${starterCode}</textarea>
                              </div>
                              <div class="code-controls">
                                <button class="run-code-btn" onclick="runPythonCode('${blockId}')">
                                  <i class="fas fa-play"></i> Run Code
                                </button>
                                <button class="clear-output-btn" onclick="clearOutput('${blockId}')">
                                  <i class="fas fa-trash"></i> Clear Output
                                </button>
                                ${
                                  solutionHtml
                                    ? `<button class="show-solution-btn" onclick="showSolution('${blockId}')"><i class="fas fa-lightbulb"></i> Show Solution</button>`
                                    : ""
                                }
                                ${
                                  hintsHtml
                                    ? `<button class="show-hints-btn" onclick="showHints('${blockId}')"><i class="fas fa-question-circle"></i> Show Hints</button>`
                                    : ""
                                }
                              </div>
                              <div class="code-output">
                                <div class="output-header">Output:</div>
                                <pre id="code-output-${blockId}" class="output-content"></pre>
                              </div>
                              ${
                                expectedOutput
                                  ? `<div class="expected-output"><strong>Expected Output:</strong><pre>${expectedOutput}</pre></div>`
                                  : ""
                              }
                              ${
                                hintsHtml
                                  ? `<div class="hints-content" id="hints-${blockId}" style="display: none;"><strong>Hints:</strong><ul>${hintsHtml}</ul></div>`
                                  : ""
                              }
                              ${
                                solutionHtml
                                  ? `<div class="solution-content" id="solution-${blockId}" style="display: none;"><strong>Solution:</strong><pre><code>${solutionHtml}</code></pre></div>`
                                  : ""
                              }
                            </div>
                          </div>
                        `;
                      case "summary": {
                        const summaryHtml = processInlineCode(item.text);
                        return summaryHtml
                          ? `<p><strong>${summaryHtml}</strong></p>`
                          : "";
                      }
                      default:
                        return "";
                    }
                  })
                  .join("");
              }

              /**
               * Renders lesson content in the main content area.
               */
              function renderLesson(topic) {
                const lesson = resolveLesson(topic);

                if (!lesson) {
                  const escapedTopic = escapeHtml(topic || "");
                  contentDisplayArea.innerHTML = `<h2>Content Not Found</h2><p>Sorry, we couldn't find a lesson for "${escapedTopic}".</p>`;
                  return;
                }

                // Hide the welcome message and show lesson content
                welcomeMessageContainer.classList.add("hidden");

                const lessonTitle = renderInlineMarkdown(lesson.title || "Lesson");
                let contentHtml = `<h2>${lessonTitle}</h2>`;
                (lesson.content || []).forEach((item) => {
                  if (item.type === "header") {
                    const headerHtml = renderInlineMarkdown(item.text || "");
                    if (headerHtml) {
                      contentHtml += `<h5>${headerHtml}</h5>`;
                    }
                  } else if (item.type === "paragraph") {
                    const paragraphHtml = renderBlockMarkdown(item.text || "");
                    if (paragraphHtml) {
                      contentHtml += paragraphHtml;
                    }
                  } else if (item.type === "list") {
                    const listItems = (item.items || [])
                      .map((li_text) => {
                        const liHtml = renderInlineMarkdown(li_text || "");
                        return liHtml ? `<li>${liHtml}</li>` : "";
                      })
                      .join("");
                    if (listItems) {
                      contentHtml += `<ul>${listItems}</ul>`;
                    }
                  } else if (item.type === "code") {
                    const escapedCode = escapeHtml(item.text || "");
                    contentHtml += `<pre><code>${escapedCode}</code></pre>`;
                  } else if (item.type === "code_runner") {
                    const blockId = Math.random().toString(36).substr(2, 9);
                    const starterCode = escapeHtml(
                      item.starter_code || '# Write your Python code here\nprint("Hello, World!")'
                    );
                    const expectedOutput = escapeHtml(item.expected_output || "");
                    const hintsHtml = (item.hints || [])
                      .map((hint) => {
                        const hintHtml = renderInlineMarkdown(hint || "");
                        return hintHtml ? `<li>${hintHtml}</li>` : "";
                      })
                      .join("");
                    const solutionHtml = escapeHtml(item.solution || "");
                    contentHtml += `
                      <div class="code-runner-block" id="code-runner-${blockId}">
                        <div class="code-runner-header">
                          <h4><i class="fas fa-play-circle"></i> Interactive Python Code</h4>
                          <button class="code-runner-toggle" type="button" onclick="toggleCodeRunner('${blockId}')" aria-expanded="false" aria-label="Expand code runner">
                            <i class="fas fa-expand-alt"></i>
                          </button>
                        </div>
                        <div class="code-runner-content">
                          <div class="code-editor">
                            <textarea id="code-editor-${blockId}" class="python-editor" placeholder="Write your Python code here...">${starterCode}</textarea>
                          </div>
                          <div class="code-controls">
                            <button class="run-code-btn" onclick="runPythonCode('${blockId}')">
                              <i class="fas fa-play"></i> Run Code
                            </button>
                            <button class="clear-output-btn" onclick="clearOutput('${blockId}')">
                              <i class="fas fa-trash"></i> Clear Output
                            </button>
                            ${solutionHtml ? `<button class="show-solution-btn" onclick="showSolution('${blockId}')"><i class="fas fa-lightbulb"></i> Show Solution</button>` : ''}
                            ${hintsHtml ? `<button class="show-hints-btn" onclick="showHints('${blockId}')"><i class="fas fa-question-circle"></i> Show Hints</button>` : ''}
                          </div>
                          <div class="code-output">
                            <div class="output-header">Output:</div>
                            <pre id="code-output-${blockId}" class="output-content"></pre>
                          </div>
                          ${expectedOutput ? `<div class="expected-output"><strong>Expected Output:</strong><pre>${expectedOutput}</pre></div>` : ''}
                          ${hintsHtml ? `<div class="hints-content" id="hints-${blockId}" style="display: none;"><strong>Hints:</strong><ul>${hintsHtml}</ul></div>` : ''}
                          ${solutionHtml ? `<div class="solution-content" id="solution-${blockId}" style="display: none;"><strong>Solution:</strong><pre><code>${solutionHtml}</code></pre></div>` : ''}
                        </div>
                      </div>
                    `;
                  } else if (item.type === "summary") {
                    const summaryHtml = renderBlockMarkdown(item.text || "");
                    if (summaryHtml) {
                      contentHtml += `<div class="lesson-summary">${summaryHtml}</div>`;
                    }
                  }
                });

                const safeTopicId = topic.replace(/[^a-zA-Z0-9]/g, "_");
                const lessonTitle = renderInlineMarkdown(lesson.title || "Lesson");
                contentDisplayArea.innerHTML = `
                  <div class="lesson-content" id="lesson-content-${safeTopicId}">
                    <h2>${lessonTitle}</h2>
                    <div class="lesson-body">
                      ${lessonHTML}
                    </div>
                  </div>
                `;
              }

              /**
               * Renders the YouTube video player in the main content area.
               */
              function renderVideo(topic, completionKey) {
                const completionKeyToUse = completionKey || topic;

                // Hide welcome message
                welcomeMessageContainer.classList.add("hidden");

                const lookupResult = lookupVideoData(topic, completionKeyToUse);
                const videoData = lookupResult ? lookupResult.data : null;
                const resolvedKey = lookupResult ? lookupResult.key : null;

                if (!videoData) {
                  contentDisplayArea.innerHTML = `
                    <h2>Video Not Available</h2>
                    <p>Sorry, we couldn't find a specific video for "${completionKeyToUse}".</p>
                    <p>Available video topics: ${Object.keys(VIDEO_DATA).join(
                      ", "
                    )}</p>
                    <p>Please try selecting a related topic from the list above or contact support.</p>
                  `;
                  return;
                }

                // Clean up previous player
                if (currentPlayer) {
                  currentPlayer.destroy();
                  currentPlayer = null;
                }

                // Track completion
                currentVideoTopic = completionKeyToUse;

                // Extract video ID
                const videoId = extractVideoIdFromUrl(videoData.url);
                if (!videoId) {
                  contentDisplayArea.innerHTML = `<h2>Invalid Video</h2><p>The video data is not valid.</p>`;
                  return;
                }

                // Create simple video player
                contentDisplayArea.innerHTML = `
                  <div id="video-player-container">
                    <div class="video-header">
                      <h2>${videoData.title || completionKeyToUse}</h2>
                      ${resolvedKey && resolvedKey !== completionKeyToUse
                        ? `<p><em>Note: Showing "${videoData.title}" which covers topics related to "${completionKeyToUse}"</em></p>`
                        : ""}
                    </div>
                    <div class="video-wrapper">
                      <div id="youtube-player"></div>
                    </div>
                  </div>
                `;

                // Create YouTube player
                if (window.YT && window.YT.Player) {
                  currentPlayer = new YT.Player("youtube-player", {
                    height: "315",
                    width: "560",
                    videoId: videoId,
                    playerVars: {
                      autoplay: 0,
                      rel: 0,
                      modestbranding: 1,
                      controls: 1,
                    },
                    events: {
                      onStateChange: onPlayerStateChange,
                    },
                  });
                }
              }

              /**
               * Handles video player state changes to detect when a video is finished.
               */
              function onPlayerStateChange(event) {
                // Mark as complete when video ends
                if (event.data === YT.PlayerState.ENDED && currentVideoTopic) {
                  updateCompletionState(currentVideoTopic, "watched");
                }
              }

              /**
               * Updates the completion state and the UI for the corresponding item.
               */
              /**
               * Updates the completion state and the UI for the corresponding item.
               */
              function updateCompletionState(topic, action) {
                if (!completionState[topic]) {
                  completionState[topic] = {};
                }

                if (!(action in completionState[topic])) {
                  return;
                }

                if (completionState[topic][action]) {
                  return; // Already completed
                }

                completionState[topic][action] = true;

                // Update UI
                const safeTopicId = topic.replace(/[^a-zA-Z0-9]/g, "_");
                const elementAction = action === "watched" ? "watch" : action;
                const elementId = `${elementAction}-${safeTopicId}`;
                const elementToMark = document.getElementById(elementId);

                if (elementToMark) {
                  elementToMark.classList.add("completed");
                }

                checkCompletionAndToggleButton();
              }

              /**
               * Checks the overall completion state and enables/disables the continue button.
               */
              function checkCompletionAndToggleButton() {
                // If no topics to complete (empty state), enable the button
                if (Object.keys(completionState).length === 0) {
                  continueButton.disabled = false;
                  return;
                }

                let allCompleted = true;

                topicLoop: for (const topic in completionState) {
                  const actions = completionState[topic];
                  for (const requirement in actions) {
                    if (!actions[requirement]) {
                      allCompleted = false;
                      break topicLoop;
                    }
                  }
                }

                continueButton.disabled = !allCompleted;
              }

              // Pyodide functionality for code execution
              let pyodide = null;
              let pyodideLoading = false;

              async function initPyodide() {
                if (pyodide) return pyodide;
                if (pyodideLoading) {
                  // Wait for existing initialization to complete
                  while (pyodideLoading) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                  }
                  return pyodide;
                }

                pyodideLoading = true;
                try {
                  pyodide = await loadPyodide({
                    indexURL: "https://cdn.jsdelivr.net/pyodide/v0.25.0/full/"
                  });
                  console.log("Pyodide loaded successfully");
                  return pyodide;
                } catch (error) {
                  console.error("Failed to load Pyodide:", error);
                  throw error;
                } finally {
                  pyodideLoading = false;
                }
              }

              async function runPythonCode(blockId) {
                const codeElement = document.getElementById(`code-editor-${blockId}`);
                const outputElement = document.getElementById(`code-output-${blockId}`);
                const runButton = document.querySelector(`#code-runner-${blockId} .run-code-btn`);

                if (!codeElement || !outputElement) return;

                const code = codeElement.value;
                if (!code.trim()) {
                  outputElement.textContent = "Please enter some Python code to run.";
                  return;
                }

                // Update button state
                runButton.disabled = true;
                runButton.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Running...`;
                outputElement.textContent = "Initializing Python environment...";

                try {
                  // Initialize Pyodide if not already done
                  const py = await initPyodide();

                  // Capture stdout
                  py.runPython(`
      import sys
      from io import StringIO
      sys.stdout = StringIO()
      `);

                  // Run the user's code
                  try {
                    py.runPython(code);

                    // Get the output
                    const output = py.runPython("sys.stdout.getvalue()");
                    outputElement.textContent = output || "Code executed successfully (no output)";
                    outputElement.className = "output-content success";
                  } catch (pythonError) {
                    outputElement.textContent = `Error: ${pythonError.message}`;
                    outputElement.className = "output-content error";
                  }

                } catch (error) {
                  outputElement.textContent = `Failed to run code: ${error.message}`;
                  outputElement.className = "output-content error";
                } finally {
                  // Reset button state
                  runButton.disabled = false;
                  runButton.innerHTML = `<i class="fas fa-play"></i> Run Code`;
                }
              }

              function clearOutput(blockId) {
                const outputElement = document.getElementById(`code-output-${blockId}`);
                if (outputElement) {
                  outputElement.textContent = "";
                  outputElement.className = "output-content";
                }
              }

              function showSolution(blockId) {
                const solutionElement = document.getElementById(`solution-${blockId}`);
                const button = document.querySelector(`#code-runner-${blockId} .show-solution-btn`);

                if (solutionElement && button) {
                  if (solutionElement.style.display === 'none') {
                    solutionElement.style.display = 'block';
                    button.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Solution';
                  } else {
                    solutionElement.style.display = 'none';
                    button.innerHTML = '<i class="fas fa-lightbulb"></i> Show Solution';
                  }
                }
              }

              function showHints(blockId) {
                const hintsElement = document.getElementById(`hints-${blockId}`);
                const button = document.querySelector(`#code-runner-${blockId} .show-hints-btn`);

                if (hintsElement && button) {
                  if (hintsElement.style.display === 'none') {
                    hintsElement.style.display = 'block';
                    button.innerHTML = '<i class="fas fa-question-circle"></i> Hide Hints';
                  } else {
                    hintsElement.style.display = 'none';
                    button.innerHTML = '<i class="fas fa-question-circle"></i> Show Hints';
                  }
                }
              }

              // Add tab support to all textareas (especially for code editing)
              document.addEventListener('keydown', function(e) {
                  // Handle Tab key in textareas
                  if (e.target.tagName === 'TEXTAREA' && e.key === 'Tab') {
                      e.preventDefault();

                      const textarea = e.target;
                      const start = textarea.selectionStart;
                      const end = textarea.selectionEnd;

                      // Insert 4 spaces (or a tab character) at cursor position
                      const tab = '    '; // 4 spaces for Python indentation
                      textarea.value = textarea.value.substring(0, start) + tab + textarea.value.substring(end);

                      // Move cursor after the inserted tab
                      textarea.selectionStart = textarea.selectionEnd = start + tab.length;
                  }
              });
            });

            // Modal functions for expanding code runners
            function expandCodeRunner(blockId) {
              const existingModal = document.getElementById(`code-runner-modal-${blockId}`);

              if (existingModal) {
                closeCodeRunnerModal(blockId);
              } else {
                openCodeRunnerModal(blockId);
              }
            }

            function setExpandButtonState(blockId, isExpanded) {
              const toggleBtn = document.querySelector(
                `#code-runner-${blockId} .code-runner-toggle`
              );

              if (!toggleBtn) {
                return;
              }

              toggleBtn.innerHTML = isExpanded
                ? '<i class="fas fa-compress-alt"></i>'
                : '<i class="fas fa-expand-alt"></i>';
              toggleBtn.setAttribute("aria-expanded", isExpanded ? "true" : "false");
              toggleBtn.setAttribute(
                "aria-label",
                isExpanded ? "Collapse code runner" : "Expand code runner"
              );
              toggleBtn.classList.toggle("is-expanded", isExpanded);
            }

            function collectCodeRunnerQuestion(originalBlock) {
              const fragments = [];
              let pointer = originalBlock.previousElementSibling;
              let steps = 0;

              while (pointer && steps < 3) {
                if (
                  pointer.classList &&
                  pointer.classList.contains("code-runner-block")
                ) {
                  break;
                }

                if (!pointer.matches("p, ul, ol, h2, h3, h4, h5")) {
                  break;
                }

                fragments.unshift(pointer.outerHTML);
                steps += 1;

                if (pointer.matches("h2, h3, h4, h5")) {
                  break;
                }

                pointer = pointer.previousElementSibling;
              }

              return fragments.join("");
            }

            function openCodeRunnerModal(blockId) {
              const originalBlock = document.getElementById(`code-runner-${blockId}`);
              if (!originalBlock) {
                return;
              }

              const codeRunnerContent = originalBlock.querySelector(
                ".code-runner-content"
              );
              if (!codeRunnerContent) {
                return;
              }

              const modal = document.createElement("div");
              modal.className = "code-runner-modal active";
              modal.id = `code-runner-modal-${blockId}`;

              const modalContent = document.createElement("div");
              modalContent.className = "code-runner-modal-content";

              const header = document.createElement("div");
              header.className = "code-runner-modal-header";

              const title = document.createElement("h4");
              title.innerHTML =
                '<i class="fas fa-play-circle"></i> Interactive Python Code';

              const actions = document.createElement("div");
              actions.className = "code-runner-modal-actions";

              const collapseBtn = document.createElement("button");
              collapseBtn.type = "button";
              collapseBtn.className = "code-runner-modal-collapse";
              collapseBtn.innerHTML = '<i class="fas fa-compress-alt"></i> Collapse';
              collapseBtn.addEventListener("click", () =>
                closeCodeRunnerModal(blockId)
              );

              const closeBtn = document.createElement("button");
              closeBtn.type = "button";
              closeBtn.className = "code-runner-modal-close";
              closeBtn.innerHTML = "&times;";
              closeBtn.addEventListener("click", () =>
                closeCodeRunnerModal(blockId)
              );

              actions.appendChild(collapseBtn);
              actions.appendChild(closeBtn);

              header.appendChild(title);
              header.appendChild(actions);

              const body = document.createElement("div");
              body.className = "code-runner-modal-body";

              const layout = document.createElement("div");
              layout.className = "code-runner-expanded-grid";

              const questionHTML = collectCodeRunnerQuestion(originalBlock);
              if (questionHTML) {
                const question = document.createElement("div");
                question.className = "code-runner-modal-question";
                question.innerHTML = questionHTML;
                layout.appendChild(question);
              } else {
                layout.classList.add("no-question");
              }

              const expectedOutput = codeRunnerContent.querySelector(
                ".expected-output"
              );
              const codeOutput = codeRunnerContent.querySelector(".code-output");
              const hintsElement = codeRunnerContent.querySelector(
                `#hints-${blockId}`
              );
              const solutionElement = codeRunnerContent.querySelector(
                `#solution-${blockId}`
              );

              const placeholder = document.createElement("div");
              placeholder.id = `code-runner-placeholder-${blockId}`;
              placeholder.className = "code-runner-placeholder";
              placeholder.innerHTML =
                '<i class="fas fa-external-link-alt"></i><span>Code runner is open in the expanded view</span>';

              originalBlock.insertBefore(placeholder, codeRunnerContent);

              codeRunnerContent.classList.add("code-runner-expanded");

              if (expectedOutput) {
                expectedOutput.classList.add("code-runner-modal-expected");
                layout.appendChild(expectedOutput);
              } else {
                layout.classList.add("no-expected");
              }

              const editorWrapper = document.createElement("div");
              editorWrapper.className = "code-runner-grid-editor";
              editorWrapper.appendChild(codeRunnerContent);
              layout.appendChild(editorWrapper);

              const outputWrapper = document.createElement("div");
              outputWrapper.className = "code-runner-grid-output";

              if (codeOutput) {
                outputWrapper.appendChild(codeOutput);
              }
              if (hintsElement) {
                outputWrapper.appendChild(hintsElement);
              }
              if (solutionElement) {
                outputWrapper.appendChild(solutionElement);
              }

              if (outputWrapper.childNodes.length > 0) {
                layout.appendChild(outputWrapper);
              } else {
                layout.classList.add("no-output");
              }

              body.appendChild(layout);

              modalContent.appendChild(header);
              modalContent.appendChild(body);
              modal.appendChild(modalContent);
              document.body.appendChild(modal);

              modal._extractedElements = {
                expectedOutput,
                codeOutput,
                hintsElement,
                solutionElement,
              };

              const escHandler = (event) => {
                if (event.key === "Escape") {
                  closeCodeRunnerModal(blockId);
                }
              };
              document.addEventListener("keydown", escHandler);

              const outsideClickHandler = (event) => {
                if (event.target === modal) {
                  closeCodeRunnerModal(blockId);
                }
              };
              modal.addEventListener("click", outsideClickHandler);

              modal._escapeHandler = escHandler;
              modal._outsideClickHandler = outsideClickHandler;

              setExpandButtonState(blockId, true);
            }

            function closeCodeRunnerModal(blockId) {
              const modal = document.getElementById(`code-runner-modal-${blockId}`);
              const originalBlock = document.getElementById(`code-runner-${blockId}`);
              const placeholder = document.getElementById(
                `code-runner-placeholder-${blockId}`
              );

              const codeRunnerContent = modal
                ? modal.querySelector(".code-runner-content")
                : originalBlock
                ? originalBlock.querySelector(".code-runner-content")
                : null;

              const extracted = modal ? modal._extractedElements || {} : {};

              if (codeRunnerContent) {
                const {
                  codeOutput,
                  expectedOutput,
                  hintsElement,
                  solutionElement,
                } = extracted;

                if (codeOutput && !codeRunnerContent.contains(codeOutput)) {
                  codeRunnerContent.appendChild(codeOutput);
                }

                if (expectedOutput && !codeRunnerContent.contains(expectedOutput)) {
                  expectedOutput.classList.remove("code-runner-modal-expected");
                  codeRunnerContent.appendChild(expectedOutput);
                }

                if (hintsElement && !codeRunnerContent.contains(hintsElement)) {
                  codeRunnerContent.appendChild(hintsElement);
                }

                if (solutionElement && !codeRunnerContent.contains(solutionElement)) {
                  codeRunnerContent.appendChild(solutionElement);
                }
              }

              if (codeRunnerContent && originalBlock) {
                codeRunnerContent.classList.remove("code-runner-expanded");
                if (placeholder && originalBlock.contains(placeholder)) {
                  originalBlock.insertBefore(codeRunnerContent, placeholder);
                } else {
                  originalBlock.appendChild(codeRunnerContent);
                }
              }

              if (placeholder && placeholder.parentNode) {
                placeholder.remove();
              }

              if (modal) {
                if (modal._escapeHandler) {
                  document.removeEventListener("keydown", modal._escapeHandler);
                }
                if (modal._outsideClickHandler) {
                  modal.removeEventListener("click", modal._outsideClickHandler);
                }
                delete modal._extractedElements;
                modal.remove();
              }

              setExpandButtonState(blockId, false);
            }
    </script>
  </body>
</html>
